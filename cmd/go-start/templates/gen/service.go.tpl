// Code generated by go-start. DO NOT EDIT.
// Service: {{.ModelName}}Service
// Source: {{.TableName}}

package service

import (
	"context"
	"errors"
	"fmt"

	"gorm.io/gorm"
	"{{.ModulePath}}/internal/model"
	"{{.ModulePath}}/internal/repository"
	"{{.ModulePath}}/pkg/cache"
)

// 定义错误
var (
	Err{{.ModelName}}NotFound = errors.New("{{.ModelName}} 不存在")
	Err{{.ModelName}}Exists   = errors.New("{{.ModelName}} 已存在")
)

// {{.ModelName}}Service {{.ModelName}} 服务层
//
// 职责说明：
//   - 处理 {{.ModelName}} 相关的业务逻辑
//   - 协调 Repository 和 Cache
//   - 实现事务管理
//   - 提供缓存策略
//
// 设计原则：
//   - 一个 Service 方法对应一个业务用例
//   - 复杂的业务逻辑应该放在 Service 层
//   - 使用缓存提升性能
type {{.ModelName}}Service struct {
	repo   *repository.{{.ModelName}}Repository
	db     *gorm.DB
	cache  *cache.Cache
}

// New{{.ModelName}}Service 创建 {{.ModelName}} 服务实例
func New{{.ModelName}}Service(repo *repository.{{.ModelName}}Repository, db *gorm.DB, cache *cache.Cache) *{{.ModelName}}Service {
	return &{{.ModelName}}Service{
		repo:  repo,
		db:    db,
		cache: cache,
	}
}

// Create 创建 {{.ModelName}}
//
// 业务逻辑：
//   - 检查是否已存在（根据业务需求）
//   - 创建新记录
//   - 清除相关缓存
func (s *{{.ModelName}}Service) Create(ctx context.Context, {{ToLowerCamelCase .ModelName}} *model.{{.ModelName}}) error {
	// TODO: 添加业务验证逻辑
	// 例如：检查唯一性约束
	
	if err := s.repo.Create(ctx, {{ToLowerCamelCase .ModelName}}); err != nil {
		return fmt.Errorf("创建{{.ModelName}}失败: %w", err)
	}

	// 清除缓存
	s.clearCache(ctx, {{ToLowerCamelCase .ModelName}}.ID)
	
	return nil
}

// GetByID 根据 ID 获取 {{.ModelName}}
//
// 业务逻辑：
//   - 先从缓存获取
//   - 缓存未命中则从数据库获取
//   - 将结果写入缓存
func (s *{{.ModelName}}Service) GetByID(ctx context.Context, id uint) (*model.{{.ModelName}}, error) {
	// 1. 尝试从缓存获取
	cacheKey := s.getCacheKey(id)
	if cached, err := s.cache.Get(ctx, cacheKey); err == nil {
		if {{ToLowerCamelCase .ModelName}}, ok := cached.(*model.{{.ModelName}}); ok {
			return {{ToLowerCamelCase .ModelName}}, nil
		}
	}

	// 2. 从数据库获取
	{{ToLowerCamelCase .ModelName}}, err := s.repo.GetByID(ctx, id)
	if err != nil {
		if errors.Is(err, gorm.ErrRecordNotFound) {
			return nil, Err{{.ModelName}}NotFound
		}
		return nil, err
	}

	// 3. 写入缓存
	s.cache.Set(ctx, cacheKey, {{ToLowerCamelCase .ModelName}}, cache.DefaultTTL)
	
	return {{ToLowerCamelCase .ModelName}}, nil
}

// Update 更新 {{.ModelName}}
//
// 业务逻辑：
//   - 检查是否存在
//   - 更新记录
//   - 清除缓存
func (s *{{.ModelName}}Service) Update(ctx context.Context, {{ToLowerCamelCase .ModelName}} *model.{{.ModelName}}) error {
	// 检查是否存在
	existing, err := s.repo.GetByID(ctx, {{ToLowerCamelCase .ModelName}}.ID)
	if err != nil {
		if errors.Is(err, gorm.ErrRecordNotFound) {
			return Err{{.ModelName}}NotFound
		}
		return err
	}

	// TODO: 添加业务验证逻辑
	
	// 更新
	if err := s.repo.Update(ctx, {{ToLowerCamelCase .ModelName}}); err != nil {
		return fmt.Errorf("更新{{.ModelName}}失败: %w", err)
	}

	// 清除缓存
	s.clearCache(ctx, existing.ID)
	s.clearListCache(ctx)
	
	return nil
}

// Delete 删除 {{.ModelName}}
//
// 业务逻辑：
//   - 检查是否存在
//   - 删除记录
//   - 清除缓存
func (s *{{.ModelName}}Service) Delete(ctx context.Context, id uint) error {
	// 检查是否存在
	_, err := s.repo.GetByID(ctx, id)
	if err != nil {
		if errors.Is(err, gorm.ErrRecordNotFound) {
			return Err{{.ModelName}}NotFound
		}
		return err
	}

	// 删除
	if err := s.repo.Delete(ctx, id); err != nil {
		return fmt.Errorf("删除{{.ModelName}}失败: %w", err)
	}

	// 清除缓存
	s.clearCache(ctx, id)
	s.clearListCache(ctx)
	
	return nil
}

// List 获取 {{.ModelName}} 列表（分页）
//
// 业务逻辑：
//   - 支持分页
//   - 支持排序
//   - 结果缓存
func (s *{{.ModelName}}Service) List(ctx context.Context, page, pageSize int) ([]*model.{{.ModelName}}, int64, error) {
	// 计算偏移量
	offset := (page - 1) * pageSize

	// 从数据库获取
	list, total, err := s.repo.List(ctx, offset, pageSize)
	if err != nil {
		return nil, 0, err
	}

	return list, total, nil
}

// ============ 私有辅助方法 ============

// getCacheKey 获取缓存键
func (s *{{.ModelName}}Service) getCacheKey(id uint) string {
	return fmt.Sprintf("{{ToLowerCamelCase .ModelName}}:%d", id)
}

// getListCacheKey 获取列表缓存键
func (s *{{.ModelName}}Service) getListCacheKey(page, pageSize int) string {
	return fmt.Sprintf("{{ToLowerCamelCase .ModelName}}:list:%d:%d", page, pageSize)
}

// clearCache 清除指定记录的缓存
func (s *{{.ModelName}}Service) clearCache(ctx context.Context, id uint) {
	cacheKey := s.getCacheKey(id)
	s.cache.Del(ctx, cacheKey)
}

// clearListCache 清除列表缓存
func (s *{{.ModelName}}Service) clearListCache(ctx context.Context) {
	// TODO: 可以根据需要清除所有列表页的缓存
	// 或者使用更智能的缓存失效策略
}
