// Code generated by go-start. DO NOT EDIT.
// Application: 基础设施初始化

package application

import (
	"context"
	"fmt"
	"log"
	"time"

	"gorm.io/driver/mysql"
	"gorm.io/gorm"
	"gorm.io/gorm/logger"
	"{{.ModulePath}}/internal/repository"
	"{{.ModulePath}}/internal/service"
	"{{.ModulePath}}/internal/controller"
	"{{.ModulePath}}/internal/routes"
	"{{.ModulePath}}/pkg/cache"
)

var (
	DB          *gorm.DB
	Cache       *cache.Cache
	{{range .ModelInfos}}
	{{.LowerCamelCase}}Repo  repository.{{.Name}}Repo
	{{.LowerCamelCase}}Service *service.{{.Name}}Service
	{{end}}
)

// Init 初始化基础设施
func Init(ctx context.Context) error {
	// 1. 初始化数据库
	if err := initDatabase(ctx); err != nil {
		return fmt.Errorf("初始化数据库失败: %w", err)
	}
	log.Println("✅ 数据库初始化成功")

	// 2. 初始化缓存
	initCache()
	log.Println("✅ 缓存初始化成功")

	// 3. 初始化 Repository 层
	initRepositories()
	log.Println("✅ Repository 层初始化成功")

	// 4. 初始化 Service 层
	initServices()
	log.Println("✅ Service 层初始化成功")

	// 5. 初始化 Controller 层
	initControllers()
	log.Println("✅ Controller 层初始化成功")

	return nil
}

// initDatabase 初始化数据库连接
func initDatabase(ctx context.Context) error {
	dsn := getEnv("DATABASE_DSN", "root:password@tcp(localhost:3306)/mydb?charset=utf8mb4&parseTime=True&loc=Local")

	var logLevel logger.LogLevel
	switch getEnv("LOG_LEVEL", "info") {
	case "silent":
		logLevel = logger.Silent
	case "error":
		logLevel = logger.Error
	case "warn":
		logLevel = logger.Warn
	case "info":
		logLevel = logger.Info
	default:
		logLevel = logger.Info
	}

	db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{
		Logger: logger.Default.LogMode(logLevel),
	})
	if err != nil {
		return err
	}

	// 配置连接池
	sqlDB, _ := db.DB()
	sqlDB.SetMaxIdleConns(getIntEnv("DB_MAX_IDLE_CONNS", 10))
	sqlDB.SetMaxOpenConns(getIntEnv("DB_MAX_OPEN_CONNS", 100))
	sqlDB.SetConnMaxLifetime(time.Duration(getIntEnv("DB_CONN_MAX_LIFETIME", 3600)) * time.Second)

	DB = db
	return nil
}

// initCache 初始化缓存
func initCache() {
	Cache = cache.New()
}

// initRepositories 初始化 Repository 层
func initRepositories() {
	{{range .ModelInfos}}
	{{.LowerCamelCase}}Repo = repository.New{{.Name}}Repository(DB)
	{{end}}
}

// initServices 初始化 Service 层
func initServices() {
	{{range .ModelInfos}}
	{{.LowerCamelCase}}Service = service.New{{.Name}}Service({{.LowerCamelCase}}Repo, DB, Cache)
	{{end}}
}

// initControllers 初始化 Controller 层
func initControllers() {
	// Controller 的初始化在路由注册时完成
}

// GetControllers 获取所有 Controller
func GetControllers() *routes.Controllers {
	return &routes.Controllers{
		{{range .ModelInfos}}
		{{.Name}}: controller.New{{.Name}}Controller({{.LowerCamelCase}}Service),
		{{end}}
	}
}

// getEnv 获取环境变量，支持默认值
func getEnv(key, defaultValue string) string {
	v := os.Getenv(key)
	if v == "" {
		return defaultValue
	}
	return v
}

// getIntEnv 获取整数类型的环境变量
func getIntEnv(key string, defaultValue int) int {
	v := os.Getenv(key)
	if v == "" {
		return defaultValue
	}
	var result int
	if _, err := fmt.Sscanf(v, "%d", &result); err == nil {
		return result
	}
	return defaultValue
}
