package gen

import (
	"fmt"
	"os"
	"path/filepath"
	"strings"
	"text/template"
)

// ServiceConfig Service é…ç½®
type ServiceConfig struct {
	TableName   string // è¡¨å
	ModelName   string // æ¨¡å‹åç§°
	PackageName string // åŒ…å
	ModulePath  string // æ¨¡å—è·¯å¾„
	WithCache   bool   // æ˜¯å¦å¯ç”¨ç¼“å­˜
}

// GenerateService ç”Ÿæˆ Service å±‚ä»£ç 
func (g *DatabaseGenerator) GenerateService(table TableInfo, config ServiceConfig) error {
	fmt.Printf("  ğŸ“¦ ç”Ÿæˆ %s Service...\n", config.ModelName)

	// åˆ›å»ºè¾“å‡ºç›®å½•
	outputDir := filepath.Join(g.config.Output, "internal/service")
	if err := os.MkdirAll(outputDir, 0755); err != nil {
		return fmt.Errorf("åˆ›å»ºç›®å½•å¤±è´¥: %w", err)
	}

	// ç”Ÿæˆ Service æ–‡ä»¶
	outputPath := filepath.Join(outputDir, strings.ToLower(config.ModelName)+".go")

	// ä½¿ç”¨æ¨¡æ¿ç”Ÿæˆ
	if err := g.renderServiceTemplate(outputPath, config); err != nil {
		return err
	}

	fmt.Printf("     âœ“ %sService åˆ›å»ºæˆåŠŸ\n", config.ModelName)
	return nil
}

// renderServiceTemplate æ¸²æŸ“ Service æ¨¡æ¿
func (g *DatabaseGenerator) renderServiceTemplate(outputPath string, config ServiceConfig) error {
	tmpl := `// Code generated by go-start. DO NOT EDIT.
// Service: {{.ModelName}}Service
// Source: {{.TableName}}

package service

import (
	"context"
	"errors"
	"fmt"
	"time"

	"gorm.io/gorm"
	"{{.ModulePath}}/internal/dal/model"
	"{{.ModulePath}}/internal/repository"
	{{if .WithCache}}
	"{{.ModulePath}}/pkg/cache"
	{{end}}
)

// å®šä¹‰ä¸šåŠ¡é”™è¯¯
var (
	Err{{.ModelName}}NotFound = errors.New("{{.ModelName}}ä¸å­˜åœ¨")
	Err{{.ModelName}}AlreadyExists = errors.New("{{.ModelName}}å·²å­˜åœ¨")
)

// {{.ModelName}}Service {{.ModelName}} æœåŠ¡å±‚
//
// èŒè´£è¯´æ˜ï¼š
//   - å®ç° {{.ModelName}} ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘
//   - åè°ƒ repository å±‚å’Œ cache å±‚
//   - å¤„ç†æ•°æ®çš„ç¼“å­˜ç­–ç•¥
//   - å®ç°ä¸šåŠ¡çš„æ ¡éªŒå’Œè§„åˆ™
//
// è®¾è®¡åŸåˆ™ï¼š
//   - æ‰€æœ‰æ–¹æ³•æ¥å— context.Contextï¼Œæ”¯æŒè¶…æ—¶å’Œè¿½è¸ª
//   - è¿”å›æ˜ç¡®çš„ errorï¼Œæ–¹ä¾¿ä¸Šå±‚å¤„ç†
//   - ç¼“å­˜å¤±æ•ˆç­–ç•¥ï¼šå†™æ“ä½œååˆ é™¤ç¼“å­˜ï¼Œè¯»æ“ä½œæ—¶ç¼“å­˜æœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“å¹¶å†™å…¥ç¼“å­˜
//   - ä¾èµ–æ¥å£è€Œéå…·ä½“å®ç°ï¼Œæ”¯æŒä¾èµ–æ³¨å…¥å’Œ Mock æµ‹è¯•
type {{.ModelName}}Service struct {
	repo  repository.{{.ModelName}}Repo  // ğŸ”¥ ä¾èµ–æ¥å£è€Œéå…·ä½“å®ç°
	db    *gorm.DB
	{{if .WithCache}}
	cache *cache.Cache
	{{end}}
}

// New{{.ModelName}}Service åˆ›å»º {{.ModelName}} æœåŠ¡å®ä¾‹
func New{{.ModelName}}Service(
	repo repository.{{.ModelName}}Repo,  // ğŸ”¥ æ¥å—æ¥å£å‚æ•°
	db *gorm.DB,
	{{if .WithCache}}
	cache *cache.Cache,
	{{end}}
) *{{.ModelName}}Service {
	return &{{.ModelName}}Service{
		repo:  repo,
		db:    db,
		{{if .WithCache}}
		cache: cache,
		{{end}}
	}
}

// Create åˆ›å»º {{.ModelName}}
//
// ä¸šåŠ¡é€»è¾‘ï¼š
//   1. å‚æ•°æ ¡éªŒ
//   2. æ£€æŸ¥å”¯ä¸€çº¦æŸï¼ˆå¦‚ï¼šemailã€usernameï¼‰
//   3. å†™å…¥æ•°æ®åº“
//   4. æ¸…é™¤ç›¸å…³ç¼“å­˜
//
// è¿”å›ï¼š
//   error - åˆ›å»ºå¤±è´¥æ—¶è¿”å›é”™è¯¯
func (s *{{.ModelName}}Service) Create(ctx context.Context, {{ToLowerCamelCase .ModelName}} *model.{{.ModelName}}) error {
	// 1. å‚æ•°æ ¡éªŒ
	if {{ToLowerCamelCase .ModelName}} == nil {
		return fmt.Errorf("{{.ModelName}}æ•°æ®ä¸èƒ½ä¸ºç©º")
	}

	// TODO: æ·»åŠ ä¸šåŠ¡æ ¡éªŒ
	// ä¾‹å¦‚ï¼šæ£€æŸ¥é‚®ç®±æ ¼å¼ã€ç”¨æˆ·åé•¿åº¦ç­‰

	// 2. æ£€æŸ¥å”¯ä¸€çº¦æŸ
	// TODO: æ ¹æ®è¡¨çš„å”¯ä¸€ç´¢å¼•æ·»åŠ æ£€æŸ¥
	// if exists, _ := s.repo.GetByEmail(ctx, {{ToLowerCamelCase .ModelName}}.Email); exists != nil {
	// 	return Err{{.ModelName}}AlreadyExists
	// }

	// 3. å†™å…¥æ•°æ®åº“
	if err := s.repo.Create(ctx, {{ToLowerCamelCase .ModelName}}); err != nil {
		return fmt.Errorf("åˆ›å»º{{.ModelName}}å¤±è´¥: %w", err)
	}

	// 4. æ¸…é™¤ç›¸å…³ç¼“å­˜ï¼ˆå¦‚æœ‰ï¼‰
	{{if .WithCache}}
	_ = s.deleteCache(ctx, {{ToLowerCamelCase .ModelName}}.ID)
	{{end}}

	return nil
}

// GetByID æ ¹æ® ID è·å– {{.ModelName}}
//
// ç¼“å­˜ç­–ç•¥ï¼š
//   1. å…ˆä»ç¼“å­˜æŸ¥è¯¢
//   2. ç¼“å­˜å‘½ä¸­åˆ™ç›´æ¥è¿”å›
//   3. ç¼“å­˜æœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“
//   4. æŸ¥è¯¢æˆåŠŸåå†™å…¥ç¼“å­˜ï¼Œè¿‡æœŸæ—¶é—´ 10 åˆ†é’Ÿ
//
// è¿”å›ï¼š
//   *model.{{.ModelName}} - {{.ModelName}}æ•°æ®
//   error - æŸ¥è¯¢å¤±è´¥æ—¶è¿”å›é”™è¯¯
func (s *{{.ModelName}}Service) GetByID(ctx context.Context, id uint) (*model.{{.ModelName}}, error) {
	{{if .WithCache}}
	// 1. å°è¯•ä»ç¼“å­˜è·å–
	cacheKey := s.getCacheKey(id)
	if cached, err := s.cache.Get(ctx, cacheKey); err == nil && cached != nil {
		if {{ToLowerCamelCase .ModelName}}, ok := cached.(*model.{{.ModelName}}); ok {
			return {{ToLowerCamelCase .ModelName}}, nil
		}
	}
	{{end}}

	// 2. ä»æ•°æ®åº“æŸ¥è¯¢
	{{ToLowerCamelCase .ModelName}}, err := s.repo.GetByID(ctx, id)
	if err != nil {
		if errors.Is(err, gorm.ErrRecordNotFound) {
			return nil, Err{{.ModelName}}NotFound
		}
		return nil, fmt.Errorf("æŸ¥è¯¢{{.ModelName}}å¤±è´¥: %w", err)
	}

	{{if .WithCache}}
	// 3. å†™å…¥ç¼“å­˜
	_ = s.cache.Set(ctx, cacheKey, {{ToLowerCamelCase .ModelName}}, 10*time.Minute)
	{{end}}

	return {{ToLowerCamelCase .ModelName}}, nil
}

// Update æ›´æ–° {{.ModelName}}
//
// ä¸šåŠ¡é€»è¾‘ï¼š
//   1. æ£€æŸ¥è®°å½•æ˜¯å¦å­˜åœ¨
//   2. æ‰§è¡Œæ›´æ–°
//   3. æ¸…é™¤ç›¸å…³ç¼“å­˜
//
// è¿”å›ï¼š
//   error - æ›´æ–°å¤±è´¥æ—¶è¿”å›é”™è¯¯
func (s *{{.ModelName}}Service) Update(ctx context.Context, {{ToLowerCamelCase .ModelName}} *model.{{.ModelName}}) error {
	// 1. å‚æ•°æ ¡éªŒ
	if {{ToLowerCamelCase .ModelName}} == nil || {{ToLowerCamelCase .ModelName}}.ID == 0 {
		return fmt.Errorf("æ— æ•ˆçš„{{.ModelName}}æ•°æ®")
	}

	// 2. æ£€æŸ¥æ˜¯å¦å­˜åœ¨
	exists, err := s.repo.GetByID(ctx, {{ToLowerCamelCase .ModelName}}.ID)
	if err != nil {
		if errors.Is(err, gorm.ErrRecordNotFound) {
			return Err{{.ModelName}}NotFound
		}
		return fmt.Errorf("æŸ¥è¯¢{{.ModelName}}å¤±è´¥: %w", err)
	}

	// TODO: æ·»åŠ ä¸šåŠ¡æ ¡éªŒ
	// ä¾‹å¦‚ï¼šæ£€æŸ¥å”¯ä¸€çº¦æŸæ˜¯å¦å†²çª

	// 3. æ‰§è¡Œæ›´æ–°
	if err := s.repo.Update(ctx, {{ToLowerCamelCase .ModelName}}); err != nil {
		return fmt.Errorf("æ›´æ–°{{.ModelName}}å¤±è´¥: %w", err)
	}

	// 4. æ¸…é™¤ç¼“å­˜
	{{if .WithCache}}
	_ = s.deleteCache(ctx, exists.ID)
	_ = s.deleteCache(ctx, {{ToLowerCamelCase .ModelName}}.ID)
	{{end}}

	return nil
}

// Delete åˆ é™¤ {{.ModelName}}
//
// ä¸šåŠ¡é€»è¾‘ï¼š
//   1. æ£€æŸ¥è®°å½•æ˜¯å¦å­˜åœ¨
//   2. æ‰§è¡Œè½¯åˆ é™¤æˆ–ç¡¬åˆ é™¤
//   3. æ¸…é™¤ç›¸å…³ç¼“å­˜
//
// è¿”å›ï¼š
//   error - åˆ é™¤å¤±è´¥æ—¶è¿”å›é”™è¯¯
func (s *{{.ModelName}}Service) Delete(ctx context.Context, id uint) error {
	// 1. æ£€æŸ¥æ˜¯å¦å­˜åœ¨
	_, err := s.repo.GetByID(ctx, id)
	if err != nil {
		if errors.Is(err, gorm.ErrRecordNotFound) {
			return Err{{.ModelName}}NotFound
		}
		return fmt.Errorf("æŸ¥è¯¢{{.ModelName}}å¤±è´¥: %w", err)
	}

	// 2. æ‰§è¡Œåˆ é™¤
	if err := s.repo.Delete(ctx, id); err != nil {
		return fmt.Errorf("åˆ é™¤{{.ModelName}}å¤±è´¥: %w", err)
	}

	// 3. æ¸…é™¤ç¼“å­˜
	{{if .WithCache}}
	_ = s.deleteCache(ctx, id)
	{{end}}

	return nil
}

// List è·å– {{.ModelName}} åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
//
// ä¸šåŠ¡é€»è¾‘ï¼š
//   1. å‚æ•°æ ¡éªŒå’Œé»˜è®¤å€¼å¤„ç†
//   2. æŸ¥è¯¢æ•°æ®åº“
//   3. è¿”å›åˆ†é¡µç»“æœ
//
// å‚æ•°ï¼š
//   ctx - è¯·æ±‚ä¸Šä¸‹æ–‡
//   page - é¡µç ï¼Œä» 1 å¼€å§‹
//   pageSize - æ¯é¡µæ•°é‡
//
// è¿”å›ï¼š
//   []*model.{{.ModelName}} - {{.ModelName}}åˆ—è¡¨
//   int64 - æ€»æ•°é‡
//   error - æŸ¥è¯¢å¤±è´¥æ—¶è¿”å›é”™è¯¯
func (s *{{.ModelName}}Service) List(ctx context.Context, page, pageSize int) ([]*model.{{.ModelName}}, int64, error) {
	// 1. å‚æ•°æ ¡éªŒ
	if page <= 0 {
		page = 1
	}
	if pageSize <= 0 || pageSize > 100 {
		pageSize = 20
	}

	// 2. æŸ¥è¯¢æ•°æ®åº“
	{{ToLowerCamelCase .ModelName}}s, total, err := s.repo.List(ctx, page, pageSize)
	if err != nil {
		return nil, 0, fmt.Errorf("æŸ¥è¯¢{{.ModelName}}åˆ—è¡¨å¤±è´¥: %w", err)
	}

	return {{ToLowerCamelCase .ModelName}}s, total, nil
}

// Count ç»Ÿè®¡ {{.ModelName}} æ€»æ•°
func (s *{{.ModelName}}Service) Count(ctx context.Context) (int64, error) {
	return s.repo.Count(ctx)
}

{{if .WithCache}}
// ============ ç¼“å­˜è¾…åŠ©æ–¹æ³• ============

// getCacheKey ç”Ÿæˆç¼“å­˜é”®
func (s *{{.ModelName}}Service) getCacheKey(id uint) string {
	return fmt.Sprintf("{{ToLowerCamelCase .ModelName}}:%d", id)
}

// deleteCache åˆ é™¤ç¼“å­˜
func (s *{{.ModelName}}Service) deleteCache(ctx context.Context, id uint) error {
	cacheKey := s.getCacheKey(id)
	return s.cache.Delete(ctx, cacheKey)
}

// deleteListCache åˆ é™¤åˆ—è¡¨ç¼“å­˜
func (s *{{.ModelName}}Service) deleteListCache(ctx context.Context) error {
	// åˆ é™¤æ‰€æœ‰ç›¸å…³çš„åˆ—è¡¨ç¼“å­˜
	pattern := "{{ToLowerCamelCase .ModelName}}:list:*"
	return s.cache.DeleteByPattern(ctx, pattern)
}
{{end}}
`

	// åˆ›å»ºæ¨¡æ¿å¹¶æ·»åŠ è¾…åŠ©å‡½æ•°
	funcMap := template.FuncMap{
		"ToLowerCamelCase": toLowerCamelCase,
	}
	t, err := template.New("service").Funcs(funcMap).Parse(tmpl)
	if err != nil {
		return fmt.Errorf("è§£ææ¨¡æ¿å¤±è´¥: %w", err)
	}

	// åˆ›å»ºæ–‡ä»¶
	f, err := os.Create(outputPath)
	if err != nil {
		return fmt.Errorf("åˆ›å»ºæ–‡ä»¶å¤±è´¥: %w", err)
	}
	defer f.Close()

	// æ‰§è¡Œæ¨¡æ¿
	data := map[string]interface{}{
		"TableName":   config.TableName,
		"ModelName":   config.ModelName,
		"PackageName": config.PackageName,
		"ModulePath":  config.ModulePath,
		"WithCache":   config.WithCache,
	}

	if err := t.Execute(f, data); err != nil {
		return fmt.Errorf("æ‰§è¡Œæ¨¡æ¿å¤±è´¥: %w", err)
	}

	return nil
}
