package gen

import (
	"fmt"
	"os"
	"path/filepath"
	"text/template"
)

// GenerateApplicationPackage ç”Ÿæˆ application åŒ…
func (g *DatabaseGenerator) GenerateApplicationPackage(modulePath string, modelNames []string) error {
	outputDir := filepath.Join(g.config.Output, "internal/application")
	if err := os.MkdirAll(outputDir, 0755); err != nil {
		return fmt.Errorf("åˆ›å»º application ç›®å½•å¤±è´¥: %w", err)
	}

	outputPath := filepath.Join(outputDir, "application.go")

	// æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
	if _, err := os.Stat(outputPath); err == nil {
		return nil
	}

	fmt.Println("ğŸ“¦ æ­£åœ¨ç”Ÿæˆ internal/application/application.go...")

	tmpl := `// Code generated by go-start. DO NOT EDIT.
// Application: åŸºç¡€è®¾æ–½åˆå§‹åŒ–

package application

import (
	"context"
	"fmt"
	"log"
	"time"

	"gorm.io/driver/mysql"
	"gorm.io/gorm"
	"gorm.io/gorm/logger"
	"{{.ModulePath}}/internal/repository"
	"{{.ModulePath}}/internal/service"
	"{{.ModulePath}}/internal/controller"
	"{{.ModulePath}}/internal/routes"
	"{{.ModulePath}}/pkg/cache"
)

var (
	DB          *gorm.DB
	Cache       *cache.Cache
	{{range .ModelInfos}}
	{{.LowerCamelCase}}Repo  repository.{{.Name}}Repo
	{{.LowerCamelCase}}Service *service.{{.Name}}Service
	{{end}}
)

// Init åˆå§‹åŒ–åŸºç¡€è®¾æ–½
//
// åˆå§‹åŒ–é¡ºåºï¼š
//   1. æ•°æ®åº“è¿æ¥
//   2. Redis ç¼“å­˜
//   3. Repository å±‚
//   4. Service å±‚
//   5. Controller å±‚
func Init(ctx context.Context) error {
	// 1. åˆå§‹åŒ–æ•°æ®åº“
	if err := initDatabase(ctx); err != nil {
		return fmt.Errorf("åˆå§‹åŒ–æ•°æ®åº“å¤±è´¥: %w", err)
	}
	log.Println("âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ")

	// 2. åˆå§‹åŒ–ç¼“å­˜
	initCache()
	log.Println("âœ… ç¼“å­˜åˆå§‹åŒ–æˆåŠŸ")

	// 3. åˆå§‹åŒ– Repository å±‚
	initRepositories()
	log.Println("âœ… Repository å±‚åˆå§‹åŒ–æˆåŠŸ")

	// 4. åˆå§‹åŒ– Service å±‚
	initServices()
	log.Println("âœ… Service å±‚åˆå§‹åŒ–æˆåŠŸ")

	// 5. åˆå§‹åŒ– Controller å±‚
	initControllers()
	log.Println("âœ… Controller å±‚åˆå§‹åŒ–æˆåŠŸ")

	return nil
}

// initDatabase åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
func initDatabase(ctx context.Context) error {
	dsn := getEnv("DATABASE_DSN", "root:password@tcp(localhost:3306)/mydb?charset=utf8mb4&parseTime=True&loc=Local")

	var logLevel logger.LogLevel
	switch getEnv("LOG_LEVEL", "info") {
	case "silent":
		logLevel = logger.Silent
	case "error":
		logLevel = logger.Error
	case "warn":
		logLevel = logger.Warn
	case "info":
		logLevel = logger.Info
	default:
		logLevel = logger.Info
	}

	db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{
		Logger: logger.Default.LogMode(logLevel),
	})
	if err != nil {
		return err
	}

	// é…ç½®è¿æ¥æ± 
	sqlDB, _ := db.DB()
	sqlDB.SetMaxIdleConns(getIntEnv("DB_MAX_IDLE_CONNS", 10))
	sqlDB.SetMaxOpenConns(getIntEnv("DB_MAX_OPEN_CONNS", 100))
	sqlDB.SetConnMaxLifetime(time.Duration(getIntEnv("DB_CONN_MAX_LIFETIME", 3600)) * time.Second)

	DB = db
	return nil
}

// initCache åˆå§‹åŒ–ç¼“å­˜
func initCache() {
	Cache = cache.New()
}

// initRepositories åˆå§‹åŒ– Repository å±‚
func initRepositories() {
	{{range .ModelInfos}}
	{{.LowerCamelCase}}Repo = repository.New{{.Name}}Repository(DB)
	{{end}}
}

// initServices åˆå§‹åŒ– Service å±‚
func initServices() {
	{{range .ModelInfos}}
	{{.LowerCamelCase}}Service = service.New{{.Name}}Service({{.LowerCamelCase}}Repo, DB, Cache)
	{{end}}
}

// initControllers åˆå§‹åŒ– Controller å±‚
func initControllers() {
	// Controller çš„åˆå§‹åŒ–åœ¨è·¯ç”±æ³¨å†Œæ—¶å®Œæˆ
}

// GetControllers è·å–æ‰€æœ‰ Controller
func GetControllers() *routes.Controllers {
	return &routes.Controllers{
		{{range .ModelInfos}}
		{{.Name}}: controller.New{{.Name}}Controller({{.LowerCamelCase}}Service),
		{{end}}
	}
}

// getEnv è·å–ç¯å¢ƒå˜é‡ï¼Œæ”¯æŒé»˜è®¤å€¼
func getEnv(key, defaultValue string) string {
	v := os.Getenv(key)
	if v == "" {
		return defaultValue
	}
	return v
}

// getIntEnv è·å–æ•´æ•°ç±»å‹çš„ç¯å¢ƒå˜é‡
func getIntEnv(key string, defaultValue int) int {
	v := os.Getenv(key)
	if v == "" {
		return defaultValue
	}
	var result int
	if _, err := fmt.Sscanf(v, "%d", &result); err == nil {
		return result
	}
	return defaultValue
}
`

	funcMap := template.FuncMap{
		"ToLowerCamelCase": toLowerCamelCaseMain,
	}

	t, err := template.New("application").Funcs(funcMap).Parse(tmpl)
	if err != nil {
		return fmt.Errorf("è§£æ application æ¨¡æ¿å¤±è´¥: %w", err)
	}

	f, err := os.Create(outputPath)
	if err != nil {
		return fmt.Errorf("åˆ›å»º application.go å¤±è´¥: %w", err)
	}
	defer f.Close()

	// å‡†å¤‡æ¨¡å‹åç§°å’Œå°é©¼å³°åç§°çš„æ˜ å°„
	type ModelInfo struct {
		Name           string
		LowerCamelCase string
	}
	var modelInfos []ModelInfo
	for _, name := range modelNames {
		modelInfos = append(modelInfos, ModelInfo{
			Name:           name,
			LowerCamelCase: toLowerCamelCaseMain(name),
		})
	}

	data := map[string]interface{}{
		"ModulePath":  modulePath,
		"ModuleName":  filepath.Base(g.config.Output),
		"Description": "Automatically generated by go-start",
		"ModelNames":  modelNames,
		"ModelInfos":  modelInfos,
	}

	if err := t.Execute(f, data); err != nil {
		return fmt.Errorf("æ‰§è¡Œ application æ¨¡æ¿å¤±è´¥: %w", err)
	}

	fmt.Println("     âœ“ internal/application/application.go åˆ›å»ºæˆåŠŸ")
	return nil
}
