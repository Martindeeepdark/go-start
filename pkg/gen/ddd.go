package gen

import (
	"fmt"
	"os"
	"path/filepath"
	"strings"
	"text/template"
)

// DDDGenerator DDD æ¶æ„ä»£ç ç”Ÿæˆå™¨
type DDDGenerator struct {
	config Config
}

// NewDDDGenerator åˆ›å»º DDD ç”Ÿæˆå™¨
func NewDDDGenerator(config Config) *DDDGenerator {
	return &DDDGenerator{
		config: config,
	}
}

// Generate ç”Ÿæˆ DDD æ¶æ„ä»£ç 
func (g *DDDGenerator) Generate() error {
	fmt.Println("ğŸ—ï¸  å¼€å§‹ç”Ÿæˆ DDD æ¶æ„ä»£ç ...")

	// 1. ç”Ÿæˆ Domain å±‚
	if err := g.generateDomainLayer(); err != nil {
		return fmt.Errorf("ç”Ÿæˆ Domain å±‚å¤±è´¥: %w", err)
	}

	// 2. ç”Ÿæˆ Application å±‚
	if err := g.generateApplicationLayer(); err != nil {
		return fmt.Errorf("ç”Ÿæˆ Application å±‚å¤±è´¥: %w", err)
	}

	// 3. ç”Ÿæˆ Infrastructure å±‚
	if err := g.generateInfrastructureLayer(); err != nil {
		return fmt.Errorf("ç”Ÿæˆ Infrastructure å±‚å¤±è´¥: %w", err)
	}

	// 4. ç”Ÿæˆ Interface å±‚
	if err := g.generateInterfaceLayer(); err != nil {
		return fmt.Errorf("ç”Ÿæˆ Interface å±‚å¤±è´¥: %w", err)
	}

	fmt.Println("\nâœ… DDD æ¶æ„ä»£ç ç”Ÿæˆå®Œæˆï¼")
	return nil
}

// generateDomainLayer ç”Ÿæˆ Domain å±‚
func (g *DDDGenerator) generateDomainLayer() error {
	fmt.Println("\nğŸ“¦ ç”Ÿæˆ Domain å±‚...")

	for _, tableName := range g.config.Tables {
		modelName := toModelName(tableName)

		// 1. ç”Ÿæˆé¢†åŸŸæ¨¡å‹ï¼ˆEntityï¼‰
		if err := g.generateDomainEntity(tableName, modelName); err != nil {
			return err
		}

		// 2. ç”Ÿæˆä»“å‚¨æ¥å£ï¼ˆRepository Interfaceï¼‰
		if err := g.generateRepositoryInterface(tableName, modelName); err != nil {
			return err
		}

		// 3. ç”Ÿæˆé¢†åŸŸæœåŠ¡ï¼ˆDomain Serviceï¼‰
		if err := g.generateDomainService(tableName, modelName); err != nil {
			return err
		}
	}

	return nil
}

// generateDomainEntity ç”Ÿæˆé¢†åŸŸå®ä½“
func (g *DDDGenerator) generateDomainEntity(tableName, modelName string) error {
	outputDir := filepath.Join(g.config.Output, "internal/domain", strings.ToLower(modelName))
	if err := os.MkdirAll(outputDir, 0755); err != nil {
		return err
	}

	outputPath := filepath.Join(outputDir, modelName+".go")

	tmpl := `// Code generated by go-start. DO NOT EDIT.
// Domain Entity: {{.ModelName}}
// Source: {{.TableName}}

package {{ToLowerCamelCase .ModelName}}

import (
	"time"
)

// {{.ModelName}} {{.ModelName}} é¢†åŸŸå®ä½“
//
// èŒè´£è¯´æ˜ï¼š
//   - å°è£… {{.ModelName}} çš„ä¸šåŠ¡è§„åˆ™å’Œè¡Œä¸º
//   - ç¡®ä¿é¢†åŸŸå¯¹è±¡çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§
//   - ä¸åŒ…å«ä»»ä½•åŸºç¡€è®¾æ–½ç»†èŠ‚ï¼ˆå¦‚æ•°æ®åº“ã€ç¼“å­˜ï¼‰
//
// è®¾è®¡åŸåˆ™ï¼š
//   - å¯Œé¢†åŸŸæ¨¡å‹ï¼ŒåŒ…å«ä¸šåŠ¡è¡Œä¸º
//   - é€šè¿‡æ–¹æ³•å°è£…ä¸šåŠ¡è§„åˆ™ï¼Œè€Œä¸æ˜¯è´«è¡€æ¨¡å‹
//   - ä½¿ç”¨å€¼å¯¹è±¡ï¼ˆValue Objectï¼‰è¡¨ç¤ºæ¦‚å¿µ
type {{.ModelName}} struct {
	ID        uint
	// TODO: æ ¹æ®æ•°æ®åº“è¡¨ç»“æ„æ·»åŠ å­—æ®µ
	// ä¾‹å¦‚ï¼š
	// Username string
	// Email    string
	// Age      int
	// CreatedAt time.Time
	// UpdatedAt time.Time

	// é¢†åŸŸäº‹ä»¶ï¼ˆå¯é€‰ï¼‰
	// events []domain.Event
}

// New{{.ModelName}} åˆ›å»º {{.ModelName}} èšåˆæ ¹
//
// å‚æ•°ï¼š
//   username - ç”¨æˆ·å
//   email - é‚®ç®±
//
// è¿”å›ï¼š
//   *{{.ModelName}} - æ–°åˆ›å»ºçš„ {{.ModelName}} å®ä½“
//   error - å‚æ•°éªŒè¯å¤±è´¥æ—¶è¿”å›é”™è¯¯
func New{{.ModelName}}(/* TODO: æ·»åŠ å‚æ•° */) (*{{.ModelName}}, error) {
	entity := &{{.ModelName}}{
		// TODO: åˆå§‹åŒ–å­—æ®µ
	}

	// ä¸šåŠ¡è§„åˆ™éªŒè¯
	if err := entity.Validate(); err != nil {
		return nil, err
	}

	return entity, nil
}

// Validate éªŒè¯ {{.ModelName}} çš„ä¸šåŠ¡è§„åˆ™
//
// è¿”å›ï¼š
//   error - è¿åä¸šåŠ¡è§„åˆ™æ—¶è¿”å›é”™è¯¯
func (e *{{.ModelName}}) Validate() error {
	// TODO: æ·»åŠ ä¸šåŠ¡è§„åˆ™éªŒè¯
	// ä¾‹å¦‚ï¼š
	// if len(e.Username) < 3 {
	// 	return fmt.Errorf("ç”¨æˆ·åè‡³å°‘3ä¸ªå­—ç¬¦")
	// }
	// if !isValidEmail(e.Email) {
	// 	return fmt.Errorf("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
	// }
	return nil
}

// ä¸šåŠ¡æ–¹æ³•ç¤ºä¾‹

// ChangeXXX ä¿®æ”¹ XXXï¼ˆä¸šåŠ¡è¡Œä¸ºï¼‰
//
// è¯´æ˜ï¼š
//   - å°è£…ä¸šåŠ¡è§„åˆ™
//   - ç¡®ä¿çŠ¶æ€å˜æ›´çš„ä¸€è‡´æ€§
//   - è§¦å‘é¢†åŸŸäº‹ä»¶ï¼ˆå¦‚æœéœ€è¦ï¼‰
//
// è¿”å›ï¼š
//   error - ä¸šåŠ¡è§„åˆ™éªŒè¯å¤±è´¥æ—¶è¿”å›é”™è¯¯
// func (e *{{.ModelName}}) ChangeXXX(newXXX string) error {
// 	// 1. ä¸šåŠ¡è§„åˆ™éªŒè¯
// 	if err := e.validateXXX(newXXX); err != nil {
// 		return err
// 	}
//
// 	// 2. æ‰§è¡ŒçŠ¶æ€å˜æ›´
// 	e.xxx = newXXX
//
// 	// 3. è§¦å‘é¢†åŸŸäº‹ä»¶
// 	// e.addEvent(domain.{{.ModelName}}ChangedEvent{...})
//
// 	return nil
// }
`

	t, err := template.New("domain_entity").Parse(tmpl)
	if err != nil {
		return err
	}

	funcMap := template.FuncMap{
		"ToLowerCamelCase": toLowerCamelCase,
	}
	t = t.Funcs(funcMap)

	f, err := os.Create(outputPath)
	if err != nil {
		return err
	}
	defer f.Close()

	data := map[string]interface{}{
		"TableName": tableName,
		"ModelName": modelName,
	}

	return t.Execute(f, data)
}

// generateRepositoryInterface ç”Ÿæˆä»“å‚¨æ¥å£
func (g *DDDGenerator) generateRepositoryInterface(tableName, modelName string) error {
	outputDir := filepath.Join(g.config.Output, "internal/domain", strings.ToLower(modelName))
	outputPath := filepath.Join(outputDir, "repository.go")

	tmpl := `// Code generated by go-start. DO NOT EDIT.
// Repository Interface: {{.ModelName}}Repository
// Source: {{.TableName}}

package {{ToLowerCamelCase .ModelName}}

import (
	"context"
)

// {{.ModelName}}Repository {{.ModelName}} ä»“å‚¨æ¥å£
//
// èŒè´£è¯´æ˜ï¼š
//   - å®šä¹‰ {{.ModelName}} çš„æŒä¹…åŒ–æŠ½è±¡
//   - éšè—åŸºç¡€è®¾æ–½ç»†èŠ‚
//   - ç”± Infrastructure å±‚å®ç°
//
// è®¾è®¡åŸåˆ™ï¼š
//   - æ¥å£å®šä¹‰åœ¨ Domain å±‚
//   - å®ç°åœ¨ Infrastructure å±‚
//   - ä½¿ç”¨èšåˆæ ¹ä½œä¸ºäº¤äº’å¯¹è±¡
type {{.ModelName}}Repository interface {
	// Save ä¿å­˜ {{.ModelName}}
	//
	// å‚æ•°ï¼š
	//   ctx - ä¸Šä¸‹æ–‡
	//   {{ToLowerCamelCase .ModelName}} - {{.ModelName}} èšåˆæ ¹
	//
	// è¿”å›ï¼š
	//   error - ä¿å­˜å¤±è´¥æ—¶è¿”å›é”™è¯¯
	Save(ctx context.Context, {{ToLowerCamelCase .ModelName}} *{{.ModelName}}) error

	// FindByID æ ¹æ® ID æŸ¥æ‰¾ {{.ModelName}}
	//
	// è¿”å›ï¼š
	//   *{{.ModelName}} - {{.ModelName}} èšåˆæ ¹ï¼Œä¸å­˜åœ¨æ—¶è¿”å› nil
	//   error - æŸ¥è¯¢å¤±è´¥æ—¶è¿”å›é”™è¯¯
	FindByID(ctx context.Context, id uint) (*{{.ModelName}}, error)

	// FindAll æŸ¥æ‰¾æ‰€æœ‰ {{.ModelName}}
	//
	// è¿”å›ï¼š
	//   []*{{.ModelName}} - {{.ModelName}} åˆ—è¡¨
	//   error - æŸ¥è¯¢å¤±è´¥æ—¶è¿”å›é”™è¯¯
	FindAll(ctx context.Context) ([]*{{.ModelName}}, error)

	// Delete åˆ é™¤ {{.ModelName}}
	//
	// è¿”å›ï¼š
	//   error - åˆ é™¤å¤±è´¥æ—¶è¿”å›é”™è¯¯
	Delete(ctx context.Context, id uint) error

	// TODO: æ·»åŠ é¢†åŸŸç‰¹å®šçš„æŸ¥è¯¢æ–¹æ³•
	// ä¾‹å¦‚ï¼š
	// FindByEmail(ctx context.Context, email string) (*{{.ModelName}}, error)
	// FindByXXX(ctx context.Context, xxx string) ([]*{{.ModelName}}, error)
}
`

	t, err := template.New("repository_interface").Parse(tmpl)
	if err != nil {
		return err
	}

	funcMap := template.FuncMap{
		"ToLowerCamelCase": toLowerCamelCase,
	}
	t = t.Funcs(funcMap)

	f, err := os.Create(outputPath)
	if err != nil {
		return err
	}
	defer f.Close()

	data := map[string]interface{}{
		"TableName": tableName,
		"ModelName": modelName,
	}

	return t.Execute(f, data)
}

// generateDomainService ç”Ÿæˆé¢†åŸŸæœåŠ¡
func (g *DDDGenerator) generateDomainService(tableName, modelName string) error {
	outputDir := filepath.Join(g.config.Output, "internal/domain", strings.ToLower(modelName))
	outputPath := filepath.Join(outputDir, "service.go")

	tmpl := `// Code generated by go-start. DO NOT EDIT.
// Domain Service: {{.ModelName}}Service
// Source: {{.TableName}}

package {{ToLowerCamelCase .ModelName}}

import (
	"context"
	"fmt"
)

// {{.ModelName}}Service {{.ModelName}} é¢†åŸŸæœåŠ¡
//
// èŒè´£è¯´æ˜ï¼š
//   - å®ç°ä¸å±äºæŸä¸ªå®ä½“çš„ä¸šåŠ¡é€»è¾‘
//   - åè°ƒå¤šä¸ªå®ä½“æˆ–å€¼å¯¹è±¡å®Œæˆä¸šåŠ¡æ“ä½œ
//   - å®ç°è·¨èšåˆæ ¹çš„ä¸šåŠ¡ç”¨ä¾‹
//
// ä½¿ç”¨åœºæ™¯ï¼š
//   - æ¶‰åŠå¤šä¸ªèšåˆæ ¹çš„ä¸šåŠ¡é€»è¾‘
//   - éœ€è¦é¢†åŸŸæœåŠ¡çš„è®¡ç®—æˆ–è½¬æ¢
//   - å¤æ‚çš„ä¸šåŠ¡è§„åˆ™éªŒè¯
type {{.ModelName}}Service struct {
	// TODO: æ³¨å…¥ä¾èµ–
	// repo {{.ModelName}}Repository
}

// New{{.ModelName}}Service åˆ›å»º {{.ModelName}} é¢†åŸŸæœåŠ¡
func New{{.ModelName}}Service(/* TODO: æ·»åŠ å‚æ•° */) *{{.ModelName}}Service {
	return &{{.ModelName}}Service{
		// TODO: åˆå§‹åŒ–å­—æ®µ
	}
}

// TODO: æ·»åŠ é¢†åŸŸæœåŠ¡æ–¹æ³•
// ä¾‹å¦‚ï¼š
//
// func (s *{{.ModelName}}Service) DoSomethingComplex(ctx context.Context, id uint) error {
// 	// 1. æŸ¥è¯¢èšåˆæ ¹
// 	// 2. ä¸šåŠ¡é€»è¾‘å¤„ç†
// 	// 3. åè°ƒå…¶ä»–èšåˆæ ¹
// 	// 4. ä¿å­˜ç»“æœ
// 	return nil
// }
`

	t, err := template.New("domain_service").Parse(tmpl)
	if err != nil {
		return err
	}

	funcMap := template.FuncMap{
		"ToLowerCamelCase": toLowerCamelCase,
	}
	t = t.Funcs(funcMap)

	f, err := os.Create(outputPath)
	if err != nil {
		return err
	}
	defer f.Close()

	data := map[string]interface{}{
		"TableName": tableName,
		"ModelName": modelName,
	}

	return t.Execute(f, data)
}

// generateApplicationLayer ç”Ÿæˆ Application å±‚
func (g *DDDGenerator) generateApplicationLayer() error {
	fmt.Println("\nğŸ“¦ ç”Ÿæˆ Application å±‚...")

	for _, tableName := range g.config.Tables {
		modelName := toModelName(tableName)

		// ç”Ÿæˆåº”ç”¨æœåŠ¡ï¼ˆApplication Serviceï¼‰
		if err := g.generateApplicationService(tableName, modelName); err != nil {
			return err
		}
	}

	return nil
}

// generateApplicationService ç”Ÿæˆåº”ç”¨æœåŠ¡
func (g *DDDGenerator) generateApplicationService(tableName, modelName string) error {
	outputDir := filepath.Join(g.config.Output, "internal/application", strings.ToLower(modelName))
	if err := os.MkdirAll(outputDir, 0755); err != nil {
		return err
	}

	outputPath := filepath.Join(outputDir, "service.go")

	tmpl := `// Code generated by go-start. DO NOT EDIT.
// Application Service: {{.ModelName}}Service
// Source: {{.TableName}}

package {{ToLowerCamelCase .ModelName}}

import (
	"context"
	"{{.ModulePath}}/internal/domain/{{ToLowerCamelCase .ModelName}}"
)

// {{.ModelName}}Service {{.ModelName}} åº”ç”¨æœåŠ¡
//
// èŒè´£è¯´æ˜ï¼š
//   - å®ç° {{.ModelName}} çš„ç”¨ä¾‹ï¼ˆUse Caseï¼‰
//   - åè°ƒé¢†åŸŸå¯¹è±¡å®Œæˆä¸šåŠ¡æ“ä½œ
//   - å¤„ç†äº‹åŠ¡è¾¹ç•Œ
//   - ä¸åŸºç¡€è®¾æ–½äº¤äº’ï¼ˆé€šè¿‡ä»“å‚¨æ¥å£ï¼‰
//
// è®¾è®¡åŸåˆ™ï¼š
//   - è–„æœåŠ¡å±‚ï¼Œä¸»è¦åšåè°ƒ
//   - ä¸šåŠ¡é€»è¾‘åœ¨ Domain å±‚
//   - ä¸ç›´æ¥ä¾èµ–åŸºç¡€è®¾æ–½å®ç°
type {{.ModelName}}Service struct {
	{{ToLowerCamelCase .ModelName}}Repo {{ToLowerCamelCase .ModelName}}.{{.ModelName}}Repository
	// TODO: æ·»åŠ å…¶ä»–ä¾èµ–ï¼ˆå¦‚å…¶ä»–èšåˆçš„ä»“å‚¨ï¼‰
}

// New{{.ModelName}}Service åˆ›å»º {{.ModelName}} åº”ç”¨æœåŠ¡
func New{{.ModelName}}Service(
	{{ToLowerCamelCase .ModelName}}Repo {{ToLowerCamelCase .ModelName}}.{{.ModelName}}Repository,
) *{{.ModelName}}Service {
	return &{{.ModelName}}Service{
		{{ToLowerCamelCase .ModelName}}Repo: {{ToLowerCamelCase .ModelName}}Repo,
	}
}

// TODO: æ·»åŠ åº”ç”¨æœåŠ¡æ–¹æ³•ï¼ˆç”¨ä¾‹ï¼‰
// ä¾‹å¦‚ï¼š
//
// // Create{{.ModelName}} åˆ›å»º {{.ModelName}} ç”¨ä¾‹
// func (s *{{.ModelName}}Service) Create{{.ModelName}}(ctx context.Context, cmd *Create{{.ModelName}}Command) error {
// 	// 1. åˆ›å»ºé¢†åŸŸå¯¹è±¡
// 	// 2. ä¸šåŠ¡éªŒè¯
// 	// 3. ä¿å­˜åˆ°ä»“å‚¨
// 	// 4. è§¦å‘é¢†åŸŸäº‹ä»¶
// 	return nil
// }
//
// // Update{{.ModelName}} æ›´æ–° {{.ModelName}} ç”¨ä¾‹
// func (s *{{.ModelName}}Service) Update{{.ModelName}}(ctx context.Context, cmd *Update{{.ModelName}}Command) error {
// 	// 1. æŸ¥è¯¢èšåˆæ ¹
// 	// 2. æ‰§è¡Œä¸šåŠ¡æ“ä½œ
// 	// 3. ä¿å­˜æ›´æ”¹
// 	return nil
// }

// Command å’Œ Query å®šä¹‰

// Create{{.ModelName}}Command åˆ›å»º {{.ModelName}} å‘½ä»¤
type Create{{.ModelName}}Command struct {
	// TODO: æ·»åŠ å­—æ®µ
}

// Update{{.ModelName}}Command æ›´æ–° {{.ModelName}} å‘½ä»¤
type Update{{.ModelName}}Command struct {
	ID uint
	// TODO: æ·»åŠ å­—æ®µ
}
`

	t, err := template.New("application_service").Parse(tmpl)
	if err != nil {
		return err
	}

	funcMap := template.FuncMap{
		"ToLowerCamelCase": toLowerCamelCase,
	}
	t = t.Funcs(funcMap)

	f, err := os.Create(outputPath)
	if err != nil {
		return err
	}
	defer f.Close()

	data := map[string]interface{}{
		"TableName":  tableName,
		"ModelName":  modelName,
		"ModulePath": getModulePath(g.config.Module),
	}

	return t.Execute(f, data)
}

// generateInfrastructureLayer ç”Ÿæˆ Infrastructure å±‚
func (g *DDDGenerator) generateInfrastructureLayer() error {
	fmt.Println("\nğŸ“¦ ç”Ÿæˆ Infrastructure å±‚...")

	for _, tableName := range g.config.Tables {
		modelName := toModelName(tableName)

		// ç”Ÿæˆä»“å‚¨å®ç°
		if err := g.generateRepositoryImpl(tableName, modelName); err != nil {
			return err
		}
	}

	return nil
}

// generateRepositoryImpl ç”Ÿæˆä»“å‚¨å®ç°
func (g *DDDGenerator) generateRepositoryImpl(tableName, modelName string) error {
	outputDir := filepath.Join(g.config.Output, "internal/infrastructure", "persistence", strings.ToLower(modelName))
	if err := os.MkdirAll(outputDir, 0755); err != nil {
		return err
	}

	outputPath := filepath.Join(outputDir, modelName+"RepositoryImpl.go")

	tmpl := `// Code generated by go-start. DO NOT EDIT.
// Repository Implementation: {{.ModelName}}RepositoryImpl
// Source: {{.TableName}}

package persistence

import (
	"context"
	"fmt"

	"gorm.io/gorm"
	"{{.ModulePath}}/internal/domain/{{ToLowerCamelCase .ModelName}}"
)

// {{.ModelName}}RepositoryImpl {{.ModelName}} ä»“å‚¨å®ç°
//
// èŒè´£è¯´æ˜ï¼š
//   - å®ç° {{.ModelName}} çš„æŒä¹…åŒ–é€»è¾‘
//   - ä½¿ç”¨ GORM ä½œä¸º ORM
//   - å¤„ç†é¢†åŸŸå¯¹è±¡ä¸æ•°æ®æ¨¡å‹çš„è½¬æ¢
//
// è®¾è®¡åŸåˆ™ï¼š
//   - åªå…³æ³¨æŒä¹…åŒ–ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
//   - å¤„ç†é¢†åŸŸæ¨¡å‹ä¸æ•°æ®æ¨¡å‹ä¹‹é—´çš„æ˜ å°„
type {{.ModelName}}RepositoryImpl struct {
	db *gorm.DB
}

// New{{.ModelName}}RepositoryImpl åˆ›å»º {{.ModelName}} ä»“å‚¨å®ç°
func New{{.ModelName}}RepositoryImpl(db *gorm.DB) {{ToLowerCamelCase .ModelName}}.{{.ModelName}}Repository {
	return &{{.ModelName}}RepositoryImpl{db: db}
}

// Save ä¿å­˜ {{.ModelName}}
func (r *{{.ModelName}}RepositoryImpl) Save(ctx context.Context, {{ToLowerCamelCase .ModelName}} *{{ToLowerCamelCase .ModelName}}.{{.ModelName}}) error {
	// TODO: è½¬æ¢ä¸ºæ•°æ®æ¨¡å‹
	// dataModel := r.toDataModel({{ToLowerCamelCase .ModelName}})
	// return r.db.WithContext(ctx).Save(dataModel).Error
	return fmt.Errorf("not implemented")
}

// FindByID æ ¹æ® ID æŸ¥æ‰¾ {{.ModelName}}
func (r *{{.ModelName}}RepositoryImpl) FindByID(ctx context.Context, id uint) (*{{ToLowerCamelCase .ModelName}}.{{.ModelName}}, error) {
	// TODO: æŸ¥è¯¢æ•°æ®æ¨¡å‹
	// var dataModel {{.ModelName}}DataModel
	// err := r.db.WithContext(ctx).First(&dataModel, id).Error
	// if err != nil {
	// 	return nil, err
	// }
	// return r.toDomainModel(&dataModel), nil
	return nil, fmt.Errorf("not implemented")
}

// FindAll æŸ¥æ‰¾æ‰€æœ‰ {{.ModelName}}
func (r *{{.ModelName}}RepositoryImpl) FindAll(ctx context.Context) ([]*{{ToLowerCamelCase .ModelName}}.{{.ModelName}}, error) {
	// TODO: æŸ¥è¯¢æ‰€æœ‰æ•°æ®æ¨¡å‹
	// var dataModels []{{.ModelName}}DataModel
	// err := r.db.WithContext(ctx).Find(&dataModels).Error
	// if err != nil {
	// 	return nil, err
	// }
	// return r.toDomainModels(dataModels), nil
	return nil, fmt.Errorf("not implemented")
}

// Delete åˆ é™¤ {{.ModelName}}
func (r *{{.ModelName}}RepositoryImpl) Delete(ctx context.Context, id uint) error {
	// TODO: åˆ é™¤æ•°æ®æ¨¡å‹
	// return r.db.WithContext(ctx).Delete(&{{.ModelName}}DataModel{}, id).Error
	return fmt.Errorf("not implemented")
}

// TODO: å®ç°é¢†åŸŸç‰¹å®šçš„æŸ¥è¯¢æ–¹æ³•
// func (r *{{.ModelName}}RepositoryImpl) FindByEmail(ctx context.Context, email string) (*{{ToLowerCamelCase .ModelName}}.{{.ModelName}}, error) {
//     // å®ç°æŸ¥è¯¢
// }

// è¾…åŠ©æ–¹æ³•ï¼šé¢†åŸŸæ¨¡å‹ä¸æ•°æ®æ¨¡å‹è½¬æ¢

// toDataModel é¢†åŸŸæ¨¡å‹è½¬æ•°æ®æ¨¡å‹
// func (r *{{.ModelName}}RepositoryImpl) toDataModel({{ToLowerCamelCase .ModelName}} *{{ToLowerCamelCase .ModelName}}.{{.ModelName}}) *{{.ModelName}}DataModel {
// 	return &{{.ModelName}}DataModel{
// 		ID: {{ToLowerCamelCase .ModelName}}.ID,
// 		// TODO: æ˜ å°„å…¶ä»–å­—æ®µ
// 	}
// }
//
// toDomainModel æ•°æ®æ¨¡å‹è½¬é¢†åŸŸæ¨¡å‹
// func (r *{{.ModelName}}RepositoryImpl) toDomainModel(dataModel *{{.ModelName}}DataModel) *{{ToLowerCamelCase .ModelName}}.{{.ModelName}} {
// 	return &{{ToLowerCamelCase .ModelName}}.{{.ModelName}}{
// 		ID: dataModel.ID,
// 		// TODO: æ˜ å°„å…¶ä»–å­—æ®µ
// 	}
// }
`

	t, err := template.New("repository_impl").Parse(tmpl)
	if err != nil {
		return err
	}

	funcMap := template.FuncMap{
		"ToLowerCamelCase": toLowerCamelCase,
	}
	t = t.Funcs(funcMap)

	f, err := os.Create(outputPath)
	if err != nil {
		return err
	}
	defer f.Close()

	data := map[string]interface{}{
		"TableName":  tableName,
		"ModelName":  modelName,
		"ModulePath": getModulePath(g.config.Module),
	}

	return t.Execute(f, data)
}

// generateInterfaceLayer ç”Ÿæˆ Interface å±‚
func (g *DDDGenerator) generateInterfaceLayer() error {
	fmt.Println("\nğŸ“¦ ç”Ÿæˆ Interface å±‚...")

	for _, tableName := range g.config.Tables {
		modelName := toModelName(tableName)

		// ç”Ÿæˆ HTTP æ§åˆ¶å™¨
		if err := g.generateHTTPController(tableName, modelName); err != nil {
			return err
		}
	}

	// ç”Ÿæˆè·¯ç”±æ³¨å†Œ
	if err := g.generateDDDRoutes(g.config.Tables); err != nil {
		return err
	}

	return nil
}

// generateHTTPController ç”Ÿæˆ HTTP æ§åˆ¶å™¨
func (g *DDDGenerator) generateHTTPController(tableName, modelName string) error {
	outputDir := filepath.Join(g.config.Output, "internal/interface", "http", strings.ToLower(modelName))
	if err := os.MkdirAll(outputDir, 0755); err != nil {
		return err
	}

	outputPath := filepath.Join(outputDir, modelName+"Controller.go")

	tmpl := `// Code generated by go-start. DO NOT EDIT.
// HTTP Controller: {{.ModelName}}Controller
// Source: {{.TableName}}

package http

import (
	"net/http"
	"strconv"

	"github.com/gin-gonic/gin"
	"{{.ModulePath}}/internal/application/{{ToLowerCamelCase .ModelName}}"
	"{{.ModulePath}}/pkg/httpx/response"
)

// {{.ModelName}}Controller {{.ModelName}} HTTP æ§åˆ¶å™¨
//
// èŒè´£è¯´æ˜ï¼š
//   - å¤„ç† {{.ModelName}} ç›¸å…³çš„ HTTP è¯·æ±‚
//   - å‚æ•°éªŒè¯å’Œç»‘å®š
//   - è°ƒç”¨åº”ç”¨æœåŠ¡å¤„ç†ç”¨ä¾‹
//   - ç»Ÿä¸€è¿”å›å“åº”æ ¼å¼
//
// è®¾è®¡åŸåˆ™ï¼š
//   - è–„æ§åˆ¶å™¨ï¼Œåªå¤„ç† HTTP ç›¸å…³é€»è¾‘
//   - ä¸šåŠ¡é€»è¾‘åœ¨ Application å±‚
//   - ä½¿ç”¨ DTO å¯¹è±¡ä¼ è¾“æ•°æ®
type {{.ModelName}}Controller struct {
	{{ToLowerCamelCase .ModelName}}Service *{{ToLowerCamelCase .ModelName}}.{{.ModelName}}Service
}

// New{{.ModelName}}Controller åˆ›å»º {{.ModelName}} æ§åˆ¶å™¨
func New{{.ModelName}}Controller(
	{{ToLowerCamelCase .ModelName}}Service *{{ToLowerCamelCase .ModelName}}.{{.ModelName}}Service,
) *{{.ModelName}}Controller {
	return &{{.ModelName}}Controller{
		{{ToLowerCamelCase .ModelName}}Service: {{ToLowerCamelCase .ModelName}}Service,
	}
}

// TODO: æ·»åŠ  HTTP å¤„ç†æ–¹æ³•
// ä¾‹å¦‚ï¼š
//
// // Create åˆ›å»º {{.ModelName}}
// func (c *{{.ModelName}}Controller) Create(ctx *gin.Context) {
// 	var cmd {{ToLowerCamelCase .ModelName}}.Create{{.ModelName}}Command
// 	if err := ctx.ShouldBindJSON(&cmd); err != nil {
// 		response.Error(ctx, http.StatusBadRequest, "å‚æ•°é”™è¯¯: "+err.Error())
// 		return
// 	}
//
// 	if err := c.{{ToLowerCamelCase .ModelName}}Service.Create{{.ModelName}}(ctx, &cmd); err != nil {
// 		response.Error(ctx, http.StatusInternalServerError, err.Error())
// 		return
// 	}
//
// 	response.Success(ctx, gin.H{"message": "åˆ›å»ºæˆåŠŸ"})
// }
//
// // GetByID è·å– {{.ModelName}} è¯¦æƒ…
// func (c *{{.ModelName}}Controller) GetByID(ctx *gin.Context) {
// 	idStr := ctx.Param("id")
// 	id, err := strconv.ParseUint(idStr, 10, 32)
// 	if err != nil {
// 		response.Error(ctx, http.StatusBadRequest, "æ— æ•ˆçš„ID")
// 		return
// 	}
//
// 	// TODO: è°ƒç”¨åº”ç”¨æœåŠ¡
// 	response.Success(ctx, gin.H{"id": id})
// }
`

	t, err := template.New("http_controller").Parse(tmpl)
	if err != nil {
		return err
	}

	funcMap := template.FuncMap{
		"ToLowerCamelCase": toLowerCamelCase,
	}
	t = t.Funcs(funcMap)

	f, err := os.Create(outputPath)
	if err != nil {
		return err
	}
	defer f.Close()

	data := map[string]interface{}{
		"TableName":  tableName,
		"ModelName":  modelName,
		"ModulePath": getModulePath(g.config.Module),
	}

	return t.Execute(f, data)
}

// generateDDDRoutes ç”Ÿæˆ DDD è·¯ç”±æ³¨å†Œ
func (g *DDDGenerator) generateDDDRoutes(tables []string) error {
	outputDir := filepath.Join(g.config.Output, "internal/interface", "http")
	if err := os.MkdirAll(outputDir, 0755); err != nil {
		return err
	}

	outputPath := filepath.Join(outputDir, "routes.go")

	tmpl := `// Code generated by go-start. DO NOT EDIT.
// DDD Routes
package http

import (
	"github.com/gin-gonic/gin"
)

// RegisterDDDRoutes æ³¨å†Œ DDD æ¶æ„çš„è·¯ç”±
//
// æ­¤æ–‡ä»¶ç”± go-start è‡ªåŠ¨ç”Ÿæˆï¼Œè¯·å‹¿æ‰‹åŠ¨ä¿®æ”¹
// å¦‚éœ€è‡ªå®šä¹‰è·¯ç”±ï¼Œè¯·åœ¨å…¶ä»–æ–‡ä»¶ä¸­æ‰‹åŠ¨æ³¨å†Œ
func RegisterDDDRoutes(r *gin.Engine, controllers *Controllers) {
	api := r.Group("/api")
	{
		{{range .ModelNames}}
		{{ToLowerCamelCase .}} := api.Group("/{{ToLowerCamelCase .}}")
		{
			// TODO: æ³¨å†Œè·¯ç”±
			// {{ToLowerCamelCase .}}.POST("", controllers.{{.}}.Create)
			// {{ToLowerCamelCase .}}.GET("/:id", controllers.{{.}}.GetByID)
		}
		{{end}}
	}
}

// Controllers DDD æ§åˆ¶å™¨é›†åˆ
type Controllers struct {
	{{range .ModelNames}}
	{{.}} *{{ToLowerCamelCase .}}.{{.}}Controller
	{{end}}
}
`

	t, err := template.New("ddd_routes").Parse(tmpl)
	if err != nil {
		return err
	}

	funcMap := template.FuncMap{
		"ToLowerCamelCase": toLowerCamelCase,
	}
	t = t.Funcs(funcMap)

	f, err := os.Create(outputPath)
	if err != nil {
		return err
	}
	defer f.Close()

	var modelNames []string
	for _, table := range tables {
		modelNames = append(modelNames, toModelName(table))
	}

	data := map[string]interface{}{
		"ModelNames": modelNames,
	}

	return t.Execute(f, data)
}
