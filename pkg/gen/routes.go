package gen

import (
	"fmt"
	"os"
	"path/filepath"
	"text/template"
)

// GenerateRoutes ç”Ÿæˆè·¯ç”±æ³¨å†Œä»£ç 
func (g *DatabaseGenerator) GenerateRoutes(tables []TableInfo, modulePath string) error {
	fmt.Println("\nğŸ“¦ æ­£åœ¨ç”Ÿæˆè·¯ç”±æ³¨å†Œ...")

	// åˆ›å»ºè¾“å‡ºç›®å½•
	outputDir := filepath.Join(g.config.Output, "internal/routes")
	if err := os.MkdirAll(outputDir, 0755); err != nil {
		return fmt.Errorf("åˆ›å»ºç›®å½•å¤±è´¥: %w", err)
	}

	// ç”Ÿæˆè·¯ç”±æ–‡ä»¶
	outputPath := filepath.Join(outputDir, "auto_routes.go")

	// ä½¿ç”¨æ¨¡æ¿ç”Ÿæˆ
	if err := g.renderRoutesTemplate(outputPath, tables, modulePath); err != nil {
		return err
	}

	fmt.Println("     âœ“ è‡ªåŠ¨è·¯ç”±æ³¨å†Œåˆ›å»ºæˆåŠŸ")
	return nil
}

// renderRoutesTemplate æ¸²æŸ“è·¯ç”±æ¨¡æ¿
func (g *DatabaseGenerator) renderRoutesTemplate(outputPath string, tables []TableInfo, modulePath string) error {
	tmpl := `// Code generated by go-start. DO NOT EDIT.
// Auto-generated routes
// Source: database tables

package routes

import (
	"github.com/gin-gonic/gin"
	"{{.ModulePath}}/internal/controller"
)

// Controllers æ§åˆ¶å™¨é›†åˆ
type Controllers struct {
	{{range .TableNames}}
	{{.Name}} *controller.{{.Name}}Controller
	{{end}}
}

// RegisterAutoRoutes è‡ªåŠ¨æ³¨å†Œæ‰€æœ‰è·¯ç”±
//
// æ­¤æ–‡ä»¶ç”± go-start è‡ªåŠ¨ç”Ÿæˆï¼Œè¯·å‹¿æ‰‹åŠ¨ä¿®æ”¹
// å¦‚éœ€è‡ªå®šä¹‰è·¯ç”±ï¼Œè¯·åœ¨å…¶ä»–æ–‡ä»¶ä¸­æ‰‹åŠ¨æ³¨å†Œ
//
// è·¯ç”±è¯´æ˜ï¼š
//   - æ¯ä¸ªè¡¨è‡ªåŠ¨ç”Ÿæˆ RESTful API
//   - POST   /api/v1/{{ToLowerCamelCase .Name}}s       - åˆ›å»º
//   - GET    /api/v1/{{ToLowerCamelCase .Name}}s       - åˆ—è¡¨
//   - GET    /api/v1/{{ToLowerCamelCase .Name}}s/:id   - è¯¦æƒ…
//   - PUT    /api/v1/{{ToLowerCamelCase .Name}}s/:id   - æ›´æ–°
//   - DELETE /api/v1/{{ToLowerCamelCase .Name}}s/:id   - åˆ é™¤
func RegisterAutoRoutes(r *gin.Engine, controllers *Controllers) {
	v1 := r.Group("/api/v1")
	{
		{{range .TableNames}}
		{{ToLowerCamelCase .Name}} := v1.Group("/{{ToLowerCamelCase .Name}}s")
		{
			{{ToLowerCamelCase .Name}}.POST("", controllers.{{.Name}}.Create)
			{{ToLowerCamelCase .Name}}.GET("", controllers.{{.Name}}.List)
			{{ToLowerCamelCase .Name}}.GET("/:id", controllers.{{.Name}}.GetByID)
			{{ToLowerCamelCase .Name}}.PUT("/:id", controllers.{{.Name}}.Update)
			{{ToLowerCamelCase .Name}}.DELETE("/:id", controllers.{{.Name}}.Delete)
		}
		{{end}}
	}
}
`

	// åˆ›å»ºæ¨¡æ¿
	t, err := template.New("routes").Parse(tmpl)
	if err != nil {
		return fmt.Errorf("è§£ææ¨¡æ¿å¤±è´¥: %w", err)
	}

	// æ·»åŠ è¾…åŠ©å‡½æ•°
	funcMap := template.FuncMap{
		"ToLowerCamelCase": toLowerCamelCase,
	}
	t = t.Funcs(funcMap)

	// åˆ›å»ºæ–‡ä»¶
	f, err := os.Create(outputPath)
	if err != nil {
		return fmt.Errorf("åˆ›å»ºæ–‡ä»¶å¤±è´¥: %w", err)
	}
	defer f.Close()

	// å‡†å¤‡æ•°æ®
	type TableName struct {
		Name string
	}
	var tableNames []TableName
	for _, table := range tables {
		tableNames = append(tableNames, TableName{
			Name: toModelName(table.Name),
		})
	}

	// æ‰§è¡Œæ¨¡æ¿
	data := map[string]interface{}{
		"ModulePath":  modulePath,
		"TableNames": tableNames,
	}

	if err := t.Execute(f, data); err != nil {
		return fmt.Errorf("æ‰§è¡Œæ¨¡æ¿å¤±è´¥: %w", err)
	}

	return nil
}
