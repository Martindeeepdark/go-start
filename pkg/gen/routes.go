package gen

import (
	"fmt"
	"os"
	"path/filepath"
	"text/template"
)

// GenerateRoutes ç”Ÿæˆè·¯ç”±æ³¨å†Œä»£ç 
func (g *DatabaseGenerator) GenerateRoutes(tables []TableInfo, modulePath string) error {
	fmt.Println("\nğŸ“¦ æ­£åœ¨ç”Ÿæˆè·¯ç”±æ³¨å†Œ...")

	// åˆ›å»ºè¾“å‡ºç›®å½•
	outputDir := filepath.Join(g.config.Output, "internal/routes")
	if err := os.MkdirAll(outputDir, 0755); err != nil {
		return fmt.Errorf("åˆ›å»ºç›®å½•å¤±è´¥: %w", err)
	}

	// ç”Ÿæˆè·¯ç”±æ–‡ä»¶
	outputPath := filepath.Join(outputDir, "auto_routes.go")

	// ä½¿ç”¨æ¨¡æ¿ç”Ÿæˆ
	if err := g.renderRoutesTemplate(outputPath, tables, modulePath); err != nil {
		return err
	}

	fmt.Println("     âœ“ è‡ªåŠ¨è·¯ç”±æ³¨å†Œåˆ›å»ºæˆåŠŸ")
	return nil
}

// renderRoutesTemplate æ¸²æŸ“è·¯ç”±æ¨¡æ¿
func (g *DatabaseGenerator) renderRoutesTemplate(outputPath string, tables []TableInfo, modulePath string) error {
	tmpl := `// Code generated by go-start. DO NOT EDIT.
// Auto-generated routes
// Source: database tables

package routes

import (
	"github.com/gin-gonic/gin"
	"{{.ModulePath}}/internal/application"
	"{{.ModulePath}}/internal/controller"
)

// RegisterRoutes æ³¨å†Œæ‰€æœ‰è·¯ç”±
//
// æ­¤å‡½æ•°åœ¨ main.go çš„ startHttpServer() ä¸­è°ƒç”¨
// ä½¿ç”¨ application åŒ…ä¸­å·²åˆå§‹åŒ–çš„ Controller
func RegisterRoutes(r *gin.Engine) {
	// å¥åº·æ£€æŸ¥
	r.GET("/health", func(c *gin.Context) {
		c.JSON(200, gin.H{
			"status": "ok",
		})
	})

	// API v1 è·¯ç”±ç»„
	v1 := r.Group("/api/v1")
	{
		{{range .TableNames}}
		register{{.Name}}Routes(v1)
		{{end}}
	}
}

{{range .TableNames}}
// register{{.Name}}Routes æ³¨å†Œ {{.Name}} ç›¸å…³è·¯ç”±
func register{{.Name}}Routes(router gin.IRouter) {
	// ä» application åŒ…è·å–å·²åˆå§‹åŒ–çš„ Service
	ctrl := controller.New{{.Name}}Controller(application.{{ToLowerCamelCase .Name}}Service)

	group := router.Group("/{{ToLowerCamelCase .Name}}s")
	{
		group.POST("", ctrl.Create)
		group.GET("", ctrl.List)
		group.GET("/:id", ctrl.GetByID)
		group.PUT("/:id", ctrl.Update)
		group.DELETE("/:id", ctrl.Delete)
	}
}
{{end}}
`

	// åˆ›å»ºæ¨¡æ¿å¹¶æ·»åŠ è¾…åŠ©å‡½æ•°
	funcMap := template.FuncMap{
		"ToLowerCamelCase": toLowerCamelCase,
	}
	t, err := template.New("routes").Funcs(funcMap).Parse(tmpl)
	if err != nil {
		return fmt.Errorf("è§£ææ¨¡æ¿å¤±è´¥: %w", err)
	}

	// åˆ›å»ºæ–‡ä»¶
	f, err := os.Create(outputPath)
	if err != nil {
		return fmt.Errorf("åˆ›å»ºæ–‡ä»¶å¤±è´¥: %w", err)
	}
	defer f.Close()

	// å‡†å¤‡æ•°æ®
	type TableName struct {
		Name string
	}
	var tableNames []TableName
	for _, table := range tables {
		tableNames = append(tableNames, TableName{
			Name: toModelName(table.Name),
		})
	}

	// æ‰§è¡Œæ¨¡æ¿
	data := map[string]interface{}{
		"ModulePath": modulePath,
		"TableNames": tableNames,
	}

	if err := t.Execute(f, data); err != nil {
		return fmt.Errorf("æ‰§è¡Œæ¨¡æ¿å¤±è´¥: %w", err)
	}

	return nil
}
