package gen

import (
	"fmt"
	"os"
	"path/filepath"
	"strings"
	"text/template"
)

// ControllerConfig Controller é…ç½®
type ControllerConfig struct {
	TableName   string   // è¡¨å
	ModelName   string   // æ¨¡å‹åç§°
	PackageName string   // åŒ…å
	ModulePath  string   // æ¨¡å—è·¯å¾„
}

// GenerateController ç”Ÿæˆ Controller å±‚ä»£ç 
func (g *DatabaseGenerator) GenerateController(table TableInfo, config ControllerConfig) error {
	fmt.Printf("  ğŸ“¦ ç”Ÿæˆ %s Controller...\n", config.ModelName)

	// åˆ›å»ºè¾“å‡ºç›®å½•
	outputDir := filepath.Join(g.config.Output, "internal/controller")
	if err := os.MkdirAll(outputDir, 0755); err != nil {
		return fmt.Errorf("åˆ›å»ºç›®å½•å¤±è´¥: %w", err)
	}

	// ç”Ÿæˆ Controller æ–‡ä»¶
	outputPath := filepath.Join(outputDir, strings.ToLower(config.ModelName)+".go")

	// ä½¿ç”¨æ¨¡æ¿ç”Ÿæˆ
	if err := g.renderControllerTemplate(outputPath, config); err != nil {
		return err
	}

	fmt.Printf("     âœ“ %sController åˆ›å»ºæˆåŠŸ\n", config.ModelName)
	return nil
}

// renderControllerTemplate æ¸²æŸ“ Controller æ¨¡æ¿
func (g *DatabaseGenerator) renderControllerTemplate(outputPath string, config ControllerConfig) error {
	tmpl := `// Code generated by go-start. DO NOT EDIT.
// Controller: {{.ModelName}}Controller
// Source: {{.TableName}}

package controller

import (
	"net/http"
	"strconv"

	"github.com/gin-gonic/gin"
	"{{.ModulePath}}/internal/model"
	"{{.ModulePath}}/internal/service"
	"{{.ModulePath}}/pkg/httpx/response"
)

// {{.ModelName}}Controller {{.ModelName}} æ§åˆ¶å™¨
//
// èŒè´£è¯´æ˜ï¼š
//   - å¤„ç† {{.ModelName}} ç›¸å…³çš„ HTTP è¯·æ±‚
//   - å‚æ•°éªŒè¯å’Œç»‘å®š
//   - è°ƒç”¨æœåŠ¡å±‚å¤„ç†ä¸šåŠ¡é€»è¾‘
//   - ç»Ÿä¸€è¿”å›å“åº”æ ¼å¼
//
// è®¾è®¡åŸåˆ™ï¼š
//   - åªå¤„ç† HTTP ç›¸å…³é€»è¾‘ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
//   - ä½¿ç”¨ response ç»Ÿä¸€è¿”å›æ ¼å¼
//   - å‚æ•°æ ¡éªŒå¤±è´¥è¿”å›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯
type {{.ModelName}}Controller struct {
	service *service.{{.ModelName}}Service
}

// New{{.ModelName}}Controller åˆ›å»º {{.ModelName}} æ§åˆ¶å™¨å®ä¾‹
func New{{.ModelName}}Controller(service *service.{{.ModelName}}Service) *{{.ModelName}}Controller {
	return &{{.ModelName}}Controller{
		service: service,
	}
}

// Create åˆ›å»º {{.ModelName}}
//
// @Summary åˆ›å»º{{.ModelName}}
// @Description åˆ›å»ºä¸€ä¸ªæ–°çš„{{.ModelName}}
// @Tags {{.ModelName}}
// @Accept json
// @Produce json
// @Param {{ToLowerCamelCase .ModelName}} body model.{{.ModelName}} true "{{.ModelName}}ä¿¡æ¯"
// @Success 200 {object} response.Response
// @Router /api/v1/{{ToLowerCamelCase .ModelName}}s [post]
func (c *{{.ModelName}}Controller) Create(ctx *gin.Context) {
	var {{ToLowerCamelCase .ModelName}} model.{{.ModelName}}
	if err := ctx.ShouldBindJSON(&{{ToLowerCamelCase .ModelName}}); err != nil {
		response.Error(ctx, http.StatusBadRequest, "å‚æ•°é”™è¯¯: "+err.Error())
		return
	}

	if err := c.service.Create(ctx, &{{ToLowerCamelCase .ModelName}}); err != nil {
		response.Error(ctx, http.StatusInternalServerError, err.Error())
		return
	}

	response.Success(ctx, gin.H{"id": {{ToLowerCamelCase .ModelName}}.ID})
}

// GetByID è·å– {{.ModelName}} è¯¦æƒ…
//
// @Summary è·å–{{.ModelName}}è¯¦æƒ…
// @Description æ ¹æ® ID è·å–{{.ModelName}}è¯¦ç»†ä¿¡æ¯
// @Tags {{.ModelName}}
// @Accept json
// @Produce json
// @Param id path int true "{{.ModelName}} ID"
// @Success 200 {object} response.Response
// @Router /api/v1/{{ToLowerCamelCase .ModelName}}s/{id} [get]
func (c *{{.ModelName}}Controller) GetByID(ctx *gin.Context) {
	idStr := ctx.Param("id")
	id, err := strconv.ParseUint(idStr, 10, 32)
	if err != nil {
		response.Error(ctx, http.StatusBadRequest, "æ— æ•ˆçš„ID")
		return
	}

	{{ToLowerCamelCase .ModelName}}, err := c.service.GetByID(ctx, uint(id))
	if err != nil {
		if err == service.Err{{.ModelName}}NotFound {
			response.Error(ctx, http.StatusNotFound, err.Error())
			return
		}
		response.Error(ctx, http.StatusInternalServerError, err.Error())
		return
	}

	response.Success(ctx, {{ToLowerCamelCase .ModelName}})
}

// Update æ›´æ–° {{.ModelName}}
//
// @Summary æ›´æ–°{{.ModelName}}
// @Description æ›´æ–°æŒ‡å®šçš„{{.ModelName}}
// @Tags {{.ModelName}}
// @Accept json
// @Produce json
// @Param id path int true "{{.ModelName}} ID"
// @Param {{ToLowerCamelCase .ModelName}} body model.{{.ModelName}} true "{{.ModelName}}ä¿¡æ¯"
// @Success 200 {object} response.Response
// @Router /api/v1/{{ToLowerCamelCase .ModelName}}s/{id} [put]
func (c *{{.ModelName}}Controller) Update(ctx *gin.Context) {
	idStr := ctx.Param("id")
	id, err := strconv.ParseUint(idStr, 10, 32)
	if err != nil {
		response.Error(ctx, http.StatusBadRequest, "æ— æ•ˆçš„ID")
		return
	}

	var {{ToLowerCamelCase .ModelName}} model.{{.ModelName}}
	if err := ctx.ShouldBindJSON(&{{ToLowerCamelCase .ModelName}}); err != nil {
		response.Error(ctx, http.StatusBadRequest, "å‚æ•°é”™è¯¯: "+err.Error())
		return
	}

	{{ToLowerCamelCase .ModelName}}.ID = uint(id)
	if err := c.service.Update(ctx, &{{ToLowerCamelCase .ModelName}}); err != nil {
		response.Error(ctx, http.StatusInternalServerError, err.Error())
		return
	}

	response.Success(ctx, nil)
}

// Delete åˆ é™¤ {{.ModelName}}
//
// @Summary åˆ é™¤{{.ModelName}}
// @Description åˆ é™¤æŒ‡å®šçš„{{.ModelName}}
// @Tags {{.ModelName}}
// @Accept json
// @Produce json
// @Param id path int true "{{.ModelName}} ID"
// @Success 200 {object} response.Response
// @Router /api/v1/{{ToLowerCamelCase .ModelName}}s/{id} [delete]
func (c *{{.ModelName}}Controller) Delete(ctx *gin.Context) {
	idStr := ctx.Param("id")
	id, err := strconv.ParseUint(idStr, 10, 32)
	if err != nil {
		response.Error(ctx, http.StatusBadRequest, "æ— æ•ˆçš„ID")
		return
	}

	if err := c.service.Delete(ctx, uint(id)); err != nil {
		response.Error(ctx, http.StatusInternalServerError, err.Error())
		return
	}

	response.Success(ctx, nil)
}

// List è·å– {{.ModelName}} åˆ—è¡¨
//
// @Summary è·å–{{.ModelName}}åˆ—è¡¨
// @Description åˆ†é¡µè·å–{{.ModelName}}åˆ—è¡¨
// @Tags {{.ModelName}}
// @Accept json
// @Produce json
// @Param page query int false "é¡µç " default(1)
// @Param page_size query int false "æ¯é¡µæ•°é‡" default(20)
// @Success 200 {object} response.Response
// @Router /api/v1/{{ToLowerCamelCase .ModelName}}s [get]
func (c *{{.ModelName}}Controller) List(ctx *gin.Context) {
	page, _ := strconv.Atoi(ctx.DefaultQuery("page", "1"))
	pageSize, _ := strconv.Atoi(ctx.DefaultQuery("page_size", "20"))

	{{ToLowerCamelCase .ModelName}}s, total, err := c.service.List(ctx, page, pageSize)
	if err != nil {
		response.Error(ctx, http.StatusInternalServerError, err.Error())
		return
	}

	response.Success(ctx, gin.H{
		"list":      {{ToLowerCamelCase .ModelName}}s,
		"total":     total,
		"page":      page,
		"page_size": pageSize,
	})
}
`

	// åˆ›å»ºæ¨¡æ¿
	t, err := template.New("controller").Parse(tmpl)
	if err != nil {
		return fmt.Errorf("è§£ææ¨¡æ¿å¤±è´¥: %w", err)
	}

	// æ·»åŠ è¾…åŠ©å‡½æ•°
	funcMap := template.FuncMap{
		"ToLowerCamelCase": toLowerCamelCase,
	}
	t = t.Funcs(funcMap)

	// åˆ›å»ºæ–‡ä»¶
	f, err := os.Create(outputPath)
	if err != nil {
		return fmt.Errorf("åˆ›å»ºæ–‡ä»¶å¤±è´¥: %w", err)
	}
	defer f.Close()

	// æ‰§è¡Œæ¨¡æ¿
	data := map[string]interface{}{
		"TableName":   config.TableName,
		"ModelName":   config.ModelName,
		"PackageName": config.PackageName,
		"ModulePath":  config.ModulePath,
	}

	if err := t.Execute(f, data); err != nil {
		return fmt.Errorf("æ‰§è¡Œæ¨¡æ¿å¤±è´¥: %w", err)
	}

	return nil
}
