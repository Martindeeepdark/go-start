package gen

import (
	"fmt"
	"os"
	"path/filepath"
	"strings"
	"text/template"
)

// RepositoryConfig Repository é…ç½®
type RepositoryConfig struct {
	TableName   string   // è¡¨å
	ModelName   string   // æ¨¡å‹åç§°
	PackageName string   // åŒ…å
	ModulePath  string   // æ¨¡å—è·¯å¾„
	Indexes     []string // ç´¢å¼•å­—æ®µåˆ—è¡¨
}

// GenerateRepository ç”Ÿæˆ Repository å±‚ä»£ç 
func (g *DatabaseGenerator) GenerateRepository(table TableInfo, config RepositoryConfig) error {
	fmt.Printf("  ğŸ“¦ ç”Ÿæˆ %s Repository...\n", config.ModelName)

	// åˆ›å»ºè¾“å‡ºç›®å½•
	outputDir := filepath.Join(g.config.Output, "internal/repository")
	if err := os.MkdirAll(outputDir, 0755); err != nil {
		return fmt.Errorf("åˆ›å»ºç›®å½•å¤±è´¥: %w", err)
	}

	// 1. ç”Ÿæˆæ¥å£æ–‡ä»¶ï¼ˆinterfaces.goï¼‰- åªç”Ÿæˆä¸€æ¬¡
	interfacesPath := filepath.Join(outputDir, "interfaces.go")
	if err := g.renderInterfacesTemplate(interfacesPath, config); err != nil {
		return err
	}

	// 2. ç”Ÿæˆ Repository å®ç°æ–‡ä»¶ï¼ˆusers.go, posts.go ç­‰ï¼‰
	outputPath := filepath.Join(outputDir, strings.ToLower(config.ModelName)+".go")
	if err := g.renderRepositoryImplTemplate(outputPath, config); err != nil {
		return err
	}

	fmt.Printf("     âœ“ %sRepository åˆ›å»ºæˆåŠŸ\n", config.ModelName)
	return nil
}

// renderInterfacesTemplate æ¸²æŸ“æ¥å£æ–‡ä»¶æ¨¡æ¿ï¼ˆç”Ÿæˆä¸€æ¬¡ï¼Œè¿½åŠ æ¨¡å¼ï¼‰
func (g *DatabaseGenerator) renderInterfacesTemplate(outputPath string, config RepositoryConfig) error {
	// æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
	if _, err := os.Stat(outputPath); err == nil {
		// æ–‡ä»¶å·²å­˜åœ¨ï¼Œè¿½åŠ æ¥å£å®šä¹‰
		return g.appendInterfaceToFile(outputPath, config)
	}

	// æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°æ–‡ä»¶
	tmpl := `// Code generated by go-start. DO NOT EDIT.
// Repository Interfaces

package repository

import (
	"context"
	"{{.ModulePath}}/internal/dal/model"
)

// {{.ModelName}}Repo {{.ModelName}} ä»“å‚¨æ¥å£
//
// è®¾è®¡ç†å¿µï¼š
//   - ä½¿ç”¨æ¥å£æŠ½è±¡æ•°æ®è®¿é—®å±‚ï¼Œä¾¿äºæµ‹è¯•å’Œæ›¿æ¢å®ç°
//   - Service å±‚ä¾èµ–æ­¤æ¥å£ï¼Œè€Œéå…·ä½“å®ç°
//   - æ”¯æŒä¾èµ–æ³¨å…¥å’Œ Mock æµ‹è¯•
type {{.ModelName}}Repo interface {
	// Create åˆ›å»º {{.ModelName}}
	Create(ctx context.Context, {{ToLowerCamelCase .ModelName}} *model.{{.ModelName}}) error

	// GetByID æ ¹æ® ID è·å– {{.ModelName}}
	GetByID(ctx context.Context, id uint) (*model.{{.ModelName}}, error)

	// Update æ›´æ–° {{.ModelName}}
	Update(ctx context.Context, {{ToLowerCamelCase .ModelName}} *model.{{.ModelName}}) error

	// Delete æ ¹æ® ID åˆ é™¤ {{.ModelName}}
	Delete(ctx context.Context, id uint) error

	// List è·å– {{.ModelName}} åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
	List(ctx context.Context, page, pageSize int) ([]*model.{{.ModelName}}, int64, error)

	// Count ç»Ÿè®¡ {{.ModelName}} æ€»æ•°
	Count(ctx context.Context) (int64, error)
{{range $index := .Indexes}}
{{if ne $index "id"}}
	// By{{$index}} æ ¹æ® {{$index}} æŸ¥è¯¢ {{$.ModelName}}
	By{{$index}}(ctx context.Context, {{$index}} interface{}) (*model.{{$.ModelName}}, error)

	// By{{$index}}List æ ¹æ® {{$index}} æŸ¥è¯¢ {{$.ModelName}} åˆ—è¡¨
	By{{$index}}List(ctx context.Context, {{$index}} interface{}) ([]*model.{{$.ModelName}}, error)
{{end}}
{{end}}
}
`

	funcMap := template.FuncMap{
		"ToLowerCamelCase": toLowerCamelCase,
	}
	t, err := template.New("interfaces").Funcs(funcMap).Parse(tmpl)
	if err != nil {
		return fmt.Errorf("è§£ææ¥å£æ¨¡æ¿å¤±è´¥: %w", err)
	}

	f, err := os.Create(outputPath)
	if err != nil {
		return fmt.Errorf("åˆ›å»ºæ¥å£æ–‡ä»¶å¤±è´¥: %w", err)
	}
	defer f.Close()

	data := map[string]interface{}{
		"TableName":   config.TableName,
		"ModelName":   config.ModelName,
		"PackageName": config.PackageName,
		"ModulePath":  config.ModulePath,
		"Indexes":     config.Indexes,
	}

	if err := t.Execute(f, data); err != nil {
		return fmt.Errorf("æ‰§è¡Œæ¥å£æ¨¡æ¿å¤±è´¥: %w", err)
	}

	return nil
}

// appendInterfaceToFile è¿½åŠ æ¥å£å®šä¹‰åˆ°ç°æœ‰æ–‡ä»¶
func (g *DatabaseGenerator) appendInterfaceToFile(outputPath string, config RepositoryConfig) error {
	// è¯»å–ç°æœ‰å†…å®¹
	content, err := os.ReadFile(outputPath)
	if err != nil {
		return fmt.Errorf("è¯»å–æ¥å£æ–‡ä»¶å¤±è´¥: %w", err)
	}

	// æ£€æŸ¥æ¥å£æ˜¯å¦å·²å®šä¹‰
	interfaceName := config.ModelName + "Repo"
	if strings.Contains(string(content), "type "+interfaceName+" interface") {
		// æ¥å£å·²å­˜åœ¨ï¼Œè·³è¿‡
		return nil
	}

	// æ‰“å¼€æ–‡ä»¶å‡†å¤‡è¿½åŠ 
	f, err := os.OpenFile(outputPath, os.O_APPEND|os.O_WRONLY, 0644)
	if err != nil {
		return fmt.Errorf("æ‰“å¼€æ¥å£æ–‡ä»¶å¤±è´¥: %w", err)
	}
	defer f.Close()

	// ç”Ÿæˆæ¥å£å®šä¹‰
	tmpl := `
// {{.ModelName}}Repo {{.ModelName}} ä»“å‚¨æ¥å£
type {{.ModelName}}Repo interface {
	Create(ctx context.Context, {{ToLowerCamelCase .ModelName}} *model.{{.ModelName}}) error
	GetByID(ctx context.Context, id uint) (*model.{{.ModelName}}, error)
	Update(ctx context.Context, {{ToLowerCamelCase .ModelName}} *model.{{.ModelName}}) error
	Delete(ctx context.Context, id uint) error
	List(ctx context.Context, page, pageSize int) ([]*model.{{.ModelName}}, int64, error)
	Count(ctx context.Context) (int64, error)
{{range $index := .Indexes}}
{{if ne $index "id"}}
	By{{$index}}(ctx context.Context, {{$index}} interface{}) (*model.{{$.ModelName}}, error)
	By{{$index}}List(ctx context.Context, {{$index}} interface{}) ([]*model.{{$.ModelName}}, error)
{{end}}
{{end}}
}
`

	funcMap := template.FuncMap{
		"ToLowerCamelCase": toLowerCamelCase,
	}
	t, err := template.New("interface_append").Funcs(funcMap).Parse(tmpl)
	if err != nil {
		return fmt.Errorf("è§£æè¿½åŠ æ¥å£æ¨¡æ¿å¤±è´¥: %w", err)
	}

	data := map[string]interface{}{
		"ModelName": config.ModelName,
		"Indexes":   config.Indexes,
	}

	if err := t.Execute(f, data); err != nil {
		return fmt.Errorf("æ‰§è¡Œè¿½åŠ æ¥å£æ¨¡æ¿å¤±è´¥: %w", err)
	}

	return nil
}

// renderRepositoryImplTemplate æ¸²æŸ“ Repository å®ç°æ¨¡æ¿
func (g *DatabaseGenerator) renderRepositoryImplTemplate(outputPath string, config RepositoryConfig) error {
	tmpl := `// Code generated by go-start. DO NOT EDIT.
// Repository: {{.ModelName}}Repository
// Source: {{.TableName}}

package repository

import (
	"context"
	"fmt"

	"gorm.io/gorm"
	"{{.ModulePath}}/internal/dal/query"
)

// {{.ModelName}}Repository {{.ModelName}} æ•°æ®è®¿é—®å±‚å®ç°
//
// èŒè´£è¯´æ˜ï¼š
//   - å°è£… {{.ModelName}} çš„æ•°æ®åº“æ“ä½œ
//   - æä¾›åŸºç¡€ CRUD æ–¹æ³•
//   - åŸºäºç´¢å¼•ç”Ÿæˆé«˜æ•ˆæŸ¥è¯¢æ–¹æ³•
//   - ä½¿ç”¨ GORM Gen ç”Ÿæˆçš„ç±»å‹å®‰å…¨ API
//
// è®¾è®¡åŸåˆ™ï¼š
//   - æ‰€æœ‰æ–¹æ³•æ¥å— context.Contextï¼Œæ”¯æŒè¶…æ—¶å’Œè¿½è¸ª
//   - è¿”å›æ˜ç¡®çš„ errorï¼Œæ–¹ä¾¿ä¸Šå±‚å¤„ç†
//   - ä½¿ç”¨ GORM Gen çš„å­—æ®µåŠ©æ‰‹ï¼Œé¿å…é­”æ³•å­—ç¬¦ä¸²
//   - å®ç° {{.ModelName}}Repo æ¥å£ï¼ˆå®šä¹‰åœ¨ interfaces.goï¼‰
type {{.ModelName}}Repository struct {
	q *query.Query
}

// ç¡®ä¿ {{.ModelName}}Repository å®ç°äº† {{.ModelName}}Repo æ¥å£
var _ {{.ModelName}}Repo = (*{{.ModelName}}Repository)(nil)

// New{{.ModelName}}Repository åˆ›å»º {{.ModelName}} ä»“å‚¨å®ä¾‹
func New{{.ModelName}}Repository(db *gorm.DB) *{{.ModelName}}Repository {
	return &{{.ModelName}}Repository{
		q: query.Use(db),
	}
}

// Create åˆ›å»º {{.ModelName}}
//
// å‚æ•°ï¼š
//   ctx - è¯·æ±‚ä¸Šä¸‹æ–‡
//   {{ToLowerCamelCase .ModelName}} - è¦åˆ›å»ºçš„æ•°æ®
//
// è¿”å›ï¼š
//   error - åˆ›å»ºå¤±è´¥æ—¶è¿”å›é”™è¯¯
func (r *{{.ModelName}}Repository) Create(ctx context.Context, {{ToLowerCamelCase .ModelName}} *model.{{.ModelName}}) error {
	return r.q.{{.ModelName}}.WithContext(ctx).Create({{ToLowerCamelCase .ModelName}})
}

// GetByID æ ¹æ® ID è·å– {{.ModelName}}
//
// è¿”å›ï¼š
//   *model.{{.ModelName}} - {{.ModelName}}æ•°æ®ï¼Œä¸å­˜åœ¨æ—¶è¿”å› nil
//   error - æŸ¥è¯¢å¤±è´¥æ—¶è¿”å›é”™è¯¯
func (r *{{.ModelName}}Repository) GetByID(ctx context.Context, id uint) (*model.{{.ModelName}}, error) {
	return r.q.{{.ModelName}}.WithContext(ctx).Where(r.q.{{.ModelName}}.ID.Eq(id)).First()
}

// Update æ›´æ–° {{.ModelName}}
//
// å‚æ•°ï¼š
//   ctx - è¯·æ±‚ä¸Šä¸‹æ–‡
//   {{ToLowerCamelCase .ModelName}} - è¦æ›´æ–°çš„æ•°æ®ï¼Œå¿…é¡»åŒ…å« ID
//
// è¿”å›ï¼š
//   error - æ›´æ–°å¤±è´¥æ—¶è¿”å›é”™è¯¯
func (r *{{.ModelName}}Repository) Update(ctx context.Context, {{ToLowerCamelCase .ModelName}} *model.{{.ModelName}}) error {
	_, err := r.q.{{.ModelName}}.WithContext(ctx).Updates({{ToLowerCamelCase .ModelName}})
	return err
}

// Delete æ ¹æ® ID åˆ é™¤ {{.ModelName}}
//
// è¿”å›ï¼š
//   error - åˆ é™¤å¤±è´¥æ—¶è¿”å›é”™è¯¯
func (r *{{.ModelName}}Repository) Delete(ctx context.Context, id uint) error {
	_, err := r.q.{{.ModelName}}.WithContext(ctx).Where(r.q.{{.ModelName}}.ID.Eq(id)).Delete()
	return err
}

// List è·å– {{.ModelName}} åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
//
// å‚æ•°ï¼š
//   ctx - è¯·æ±‚ä¸Šä¸‹æ–‡
//   page - é¡µç ï¼Œä» 1 å¼€å§‹
//   pageSize - æ¯é¡µæ•°é‡
//
// è¿”å›ï¼š
//   []*model.{{.ModelName}} - {{.ModelName}}åˆ—è¡¨
//   int64 - æ€»æ•°é‡
//   error - æŸ¥è¯¢å¤±è´¥æ—¶è¿”å›é”™è¯¯
func (r *{{.ModelName}}Repository) List(ctx context.Context, page, pageSize int) ([]*model.{{.ModelName}}, int64, error) {
	{{ToLowerCamelCase .ModelName}}s, count, err := r.q.{{.ModelName}}.WithContext(ctx).
		FindByPage(page, pageSize)
	if err != nil {
		return nil, 0, err
	}

	return {{ToLowerCamelCase .ModelName}}s, count, nil
}

// Count ç»Ÿè®¡ {{.ModelName}} æ€»æ•°
func (r *{{.ModelName}}Repository) Count(ctx context.Context) (int64, error) {
	return r.q.{{.ModelName}}.WithContext(ctx).Count()
}

{{range $index := .Indexes}}
{{if ne $index "id"}}
// By{{$index}} æ ¹æ® {{$index}} æŸ¥è¯¢ {{$.ModelName}}
//
// ä½¿ç”¨ç´¢å¼•ï¼š{{$index}}
func (r *{{$.ModelName}}Repository) By{{$index}}(ctx context.Context, {{$index}} interface{}) (*model.{{$.ModelName}}, error) {
	return r.q.{{$.ModelName}}.WithContext(ctx).
		Where(r.q.{{$.ModelName}}.{{$index}}.Eq({{$index}})).
		First()
}

// By{{$index}}List æ ¹æ® {{$index}} æŸ¥è¯¢ {{$.ModelName}} åˆ—è¡¨
func (r *{{$.ModelName}}Repository) By{{$index}}List(ctx context.Context, {{$index}} interface{}) ([]*model.{{$.ModelName}}, error) {
	return r.q.{{$.ModelName}}.WithContext(ctx).
		Where(r.q.{{$.ModelName}}.{{$index}}.Eq({{$index}})).
		Find()
}
{{end}}
{{end}}
`

	// åˆ›å»ºæ¨¡æ¿å¹¶æ·»åŠ è¾…åŠ©å‡½æ•°
	funcMap := template.FuncMap{
		"ToLowerCamelCase": toLowerCamelCase,
	}
	t, err := template.New("repository").Funcs(funcMap).Parse(tmpl)
	if err != nil {
		return fmt.Errorf("è§£ææ¨¡æ¿å¤±è´¥: %w", err)
	}

	// åˆ›å»ºæ–‡ä»¶
	f, err := os.Create(outputPath)
	if err != nil {
		return fmt.Errorf("åˆ›å»ºæ–‡ä»¶å¤±è´¥: %w", err)
	}
	defer f.Close()

	// æ‰§è¡Œæ¨¡æ¿
	data := map[string]interface{}{
		"TableName":   config.TableName,
		"ModelName":   config.ModelName,
		"PackageName": config.PackageName,
		"ModulePath":  config.ModulePath,
		"Indexes":     config.Indexes,
	}

	if err := t.Execute(f, data); err != nil {
		return fmt.Errorf("æ‰§è¡Œæ¨¡æ¿å¤±è´¥: %w", err)
	}

	return nil
}

// toLowerCamelCase è½¬æ¢ä¸ºå°é©¼å³°å‘½å
func toLowerCamelCase(s string) string {
	if len(s) == 0 {
		return s
	}
	return strings.ToLower(s[:1]) + s[1:]
}
