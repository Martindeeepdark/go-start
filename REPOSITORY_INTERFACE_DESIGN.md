# Repository æ¥å£è®¾è®¡è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æ ¹æ®ç”¨æˆ·åé¦ˆ "ä¸ºä»€ä¹ˆDBé‚£è¾¹çš„å‡½æ•°éƒ½ä¸æŠ½è±¡ä¸ºinterfaceå‘¢"ï¼Œæˆ‘ä»¬é‡æ–°è®¾è®¡äº† Repository å±‚ï¼Œå°†**æ¥å£å®šä¹‰**å’Œ**å®ç°**åˆ†ç¦»åˆ°ä¸åŒçš„æ–‡ä»¶ä¸­ã€‚

## ğŸ“ æ–°çš„æ–‡ä»¶ç»“æ„

```
internal/repository/
â”œâ”€â”€ interfaces.go          # ğŸ”¥ æ‰€æœ‰ Repository æ¥å£å®šä¹‰ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ users.go               # UserRepository å®ç°
â”œâ”€â”€ posts.go               # PostRepository å®ç°
â””â”€â”€ comments.go            # CommentRepository å®ç°
```

## ğŸ¯ è®¾è®¡ä¼˜åŠ¿

### 1. **æ¥å£å’Œå®ç°åˆ†ç¦»** âœ…
- **interfaces.go** - å®šä¹‰æ‰€æœ‰ä»“å‚¨æ¥å£ï¼ŒService å±‚ä¾èµ–æ­¤æ–‡ä»¶
- **users.go, posts.go** - å…·ä½“å®ç°ï¼Œåªå…³æ³¨å¦‚ä½•å®ç°æ¥å£

### 2. **ä¾¿äºæµ‹è¯•** âœ…
```go
// Service å±‚ä¾èµ–æ¥å£
type UserService struct {
    repo repository.UserRepo  // æ¥å£ï¼Œä¸æ˜¯å…·ä½“å®ç°
}

// å•å…ƒæµ‹è¯•æ—¶å¯ä»¥è½»æ¾ Mock
type MockUserRepo struct {}
func (m *MockUserRepo) GetByID(ctx context.Context, id uint) (*model.User, error) {
    return &model.User{ID: id, Username: "test"}, nil
}
```

### 3. **æ”¯æŒä¾èµ–æ³¨å…¥** âœ…
```go
// main.go ä¸­æ³¨å…¥å…·ä½“å®ç°
userRepo := repository.NewUserRepository(db)  // å…·ä½“å®ç°
userService := service.NewUserService(userRepo)  // ä¼ å…¥æ¥å£
```

### 4. **ç¼–è¯‘æ—¶æ£€æŸ¥** âœ…
```go
// ç¡®ä¿å®ç°å®Œå…¨ç¬¦åˆæ¥å£
var _ repository.UserRepo = (*repository.UserRepository)(nil)
```

## ğŸ“„ æ–‡ä»¶å†…å®¹ç¤ºä¾‹

### interfaces.go

```go
// Code generated by go-start. DO NOT EDIT.
// Repository Interfaces

package repository

import (
	"context"
	"github.com/username/project/internal/dal/model"
)

// UserRepo ç”¨æˆ·ä»“å‚¨æ¥å£
//
// è®¾è®¡ç†å¿µï¼š
//   - ä½¿ç”¨æ¥å£æŠ½è±¡æ•°æ®è®¿é—®å±‚ï¼Œä¾¿äºæµ‹è¯•å’Œæ›¿æ¢å®ç°
//   - Service å±‚ä¾èµ–æ­¤æ¥å£ï¼Œè€Œéå…·ä½“å®ç°
//   - æ”¯æŒä¾èµ–æ³¨å…¥å’Œ Mock æµ‹è¯•
type UserRepo interface {
	// Create åˆ›å»º User
	Create(ctx context.Context, user *model.User) error

	// GetByID æ ¹æ® ID è·å– User
	GetByID(ctx context.Context, id uint) (*model.User, error)

	// Update æ›´æ–° User
	Update(ctx context.Context, user *model.User) error

	// Delete æ ¹æ® ID åˆ é™¤ User
	Delete(ctx context.Context, id uint) error

	// List è·å– User åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
	List(ctx context.Context, page, pageSize int) ([]*model.User, int64, error)

	// Count ç»Ÿè®¡ User æ€»æ•°
	Count(ctx context.Context) (int64, error)

	// ByEmail æ ¹æ® Email æŸ¥è¯¢ User
	ByEmail(ctx context.Context, email interface{}) (*model.User, error)

	// ByEmailList æ ¹æ® Email æŸ¥è¯¢ User åˆ—è¡¨
	ByEmailList(ctx context.Context, email interface{}) ([]*model.User, error)
}
```

### users.go

```go
// Code generated by go-start. DO NOT EDIT.
// Repository: UserRepository
// Source: users

package repository

import (
	"context"
	"fmt"

	"gorm.io/gorm"
	"github.com/username/project/internal/dal/query"
)

// UserRepository ç”¨æˆ·æ•°æ®è®¿é—®å±‚å®ç°
//
// èŒè´£è¯´æ˜ï¼š
//   - å°è£… User çš„æ•°æ®åº“æ“ä½œ
//   - æä¾›åŸºç¡€ CRUD æ–¹æ³•
//   - åŸºäºç´¢å¼•ç”Ÿæˆé«˜æ•ˆæŸ¥è¯¢æ–¹æ³•
//   - ä½¿ç”¨ GORM Gen ç”Ÿæˆçš„ç±»å‹å®‰å…¨ API
//
// è®¾è®¡åŸåˆ™ï¼š
//   - æ‰€æœ‰æ–¹æ³•æ¥å— context.Contextï¼Œæ”¯æŒè¶…æ—¶å’Œè¿½è¸ª
//   - è¿”å›æ˜ç¡®çš„ errorï¼Œæ–¹ä¾¿ä¸Šå±‚å¤„ç†
//   - ä½¿ç”¨ GORM Gen çš„å­—æ®µåŠ©æ‰‹ï¼Œé¿å…é­”æ³•å­—ç¬¦ä¸²
//   - å®ç° UserRepo æ¥å£ï¼ˆå®šä¹‰åœ¨ interfaces.goï¼‰
type UserRepository struct {
	q *query.Query
}

// ç¡®ä¿ UserRepository å®ç°äº† UserRepo æ¥å£
var _ UserRepo = (*UserRepository)(nil)

// NewUserRepository åˆ›å»ºç”¨æˆ·ä»“å‚¨å®ä¾‹
func NewUserRepository(db *gorm.DB) *UserRepository {
	return &UserRepository{
		q: query.Use(db),
	}
}

// Create åˆ›å»º User
func (r *UserRepository) Create(ctx context.Context, user *model.User) error {
	return r.q.User.WithContext(ctx).Create(user)
}

// GetByID æ ¹æ® ID è·å– User
func (r *UserRepository) GetByID(ctx context.Context, id uint) (*model.User, error) {
	return r.q.User.WithContext(ctx).Where(r.q.User.ID.Eq(id)).First()
}

// ... å…¶ä»–æ–¹æ³•å®ç°
```

## ğŸ”„ Service å±‚ä½¿ç”¨

```go
// service/users.go
package service

import (
	"{{.ModulePath}}/internal/repository"
)

type UserService struct {
	repo repository.UserRepo  // ğŸ”¥ ä¾èµ–æ¥å£
	db   *gorm.DB
	cache *cache.Cache
}

func NewUserService(
	repo repository.UserRepo,  // ğŸ”¥ æ¥å—æ¥å£å‚æ•°
	db *gorm.DB,
	cache *cache.Cache,
) *UserService {
	return &UserService{
		repo:  repo,
		db:    db,
		cache: cache,
	}
}
```

## âœ… ç”¨æˆ·åé¦ˆå“åº”

**åŸé—®é¢˜**: "ä¸ºä»€ä¹ˆDBé‚£è¾¹çš„å‡½æ•°éƒ½ä¸æŠ½è±¡ä¸ºinterfaceå‘¢ è¿™æ ·å­éƒ½ä¸éœ€è¦çœ‹åº•å±‚å®ç°ï¼Œç›´æ¥è°ƒç”¨interfaceå°±å¯ä»¥äº†å•Š"

**è§£å†³æ–¹æ¡ˆ**:
1. âœ… åˆ›å»ºç‹¬ç«‹çš„ `interfaces.go` æ–‡ä»¶
2. âœ… æ‰€æœ‰æ¥å£å®šä¹‰é›†ä¸­ç®¡ç†
3. âœ… Service å±‚å®Œå…¨ä¾èµ–æ¥å£
4. âœ… æ”¯æŒä¾èµ–æ³¨å…¥å’Œ Mock æµ‹è¯•
5. âœ… ç¼–è¯‘æ—¶æ£€æŸ¥å®ç°å®Œæ•´æ€§

## ğŸ‰ æ€»ç»“

ç°åœ¨çš„ Repository å±‚è®¾è®¡ç¬¦åˆä»¥ä¸‹åŸåˆ™ï¼š
- **ä¾èµ–å€’ç½®åŸåˆ™** (DIP) - é«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚æ¨¡å—ï¼Œéƒ½ä¾èµ–æŠ½è±¡
- **æ¥å£éš”ç¦»åŸåˆ™** (ISP) - æ¥å£èŒè´£å•ä¸€
- **å¼€é—­åŸåˆ™** (OCP) - å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
- **å•ä¸€èŒè´£åŸåˆ™** (SRP) - æ¥å£å®šä¹‰å’Œå®ç°åˆ†ç¦»

ç”¨æˆ·å¯ä»¥ç›´æ¥æŸ¥çœ‹ `interfaces.go` äº†è§£æ‰€æœ‰å¯ç”¨çš„æ•°æ®è®¿é—®æ–¹æ³•ï¼Œæ— éœ€å…³å¿ƒå…·ä½“å®ç°ç»†èŠ‚ï¼
